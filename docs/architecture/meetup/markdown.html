<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="description" content="nexus">
<meta name="generator" content="Paradox, paradox-material-theme=0.5.1, mkdocs-material=3.0.3">

<meta name="lang:clipboard.copy" content="Copy to clipboard">
<meta name="lang:clipboard.copied" content="Copied to clipboard">
<meta name="lang:search.language" content="">
<meta name="lang:search.pipeline.stopwords" content="true">
<meta name="lang:search.pipeline.trimmer" content="true">
<meta name="lang:search.result.none" content="No matching documents">
<meta name="lang:search.result.one" content="1 matching document">
<meta name="lang:search.result.other" content="# matching documents">
<meta name="lang:search.tokenizer" content="[\s\-]+">


<meta name="description" content="nexus">
<link rel="shortcut icon" href="../../.././assets/img/favicon-32x32.png">
<title>BlueBrain Nexus</title>
<link rel="stylesheet" href="../../../assets/stylesheets/application.451f80e5.css">
<link rel="stylesheet" href="../../../assets/stylesheets/application-palette.22915126.css">
<meta name="theme-color" content="#03a9f4" />
<link rel="stylesheet" href="../../../lib/material__tabs/dist/mdc.tabs.min.css">
<link rel="stylesheet" href="../../../lib/prettify/prettify.css">
<script src="../../../assets/javascripts/modernizr.1aa3b519.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
<style>
body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}
code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}
</style>
<link rel="stylesheet" href="../../../assets/fonts/font-awesome.css">
<link rel="stylesheet" href="../../../assets/fonts/material-icons.css">
<link rel="stylesheet" href="../../../assets/stylesheets/paradox-material-theme.css">
<link rel="stylesheet" href="../../.././assets/css/docs.css">
</head>
<body
data-md-color-primary="light-blue"
data-md-color-accent="cyan"
>
<input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
<input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
<label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a href="../../../docs/architecture/meetup/markdown.html" title="BlueBrain Nexus" class="md-header-nav__button md-logo">
<img src="../../.././assets/img/logo.png" width="24" height="24">
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
BlueBrain Nexus
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
<label class="md-icon md-search__icon" for="__search"></label>
<button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">&#xE5CD;</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix>
<div class="md-search-result" data-md-component="result">
<div class="md-search-result__meta">
Type to start searching
</div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>

</div>
<div class="md-flex__cell md-flex__cell--shrink">
<div class="md-header-nav__source">
<a href="https://github.com/BlueBrain/nexus"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
BlueBrain/nexus
</div>
</a>

</div>
</div>
</div>
</nav>
</header>

<div class="md-container">
<main class="md-main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0" style="visibility: hidden">
<label class="md-nav__title md-nav__title--site" for="drawer">
<a href="../../../docs/architecture/meetup/markdown.html" title="BlueBrain Nexus" class="md-nav__button md-logo">
<span class="md-nav__button md-logo">
<img src="../../.././assets/img/logo.png" width="24" height="24">
</a>
<a href="../../../docs/architecture/meetup/markdown.html" title="BlueBrain Nexus">
BlueBrain Nexus
</a>
</label>
<div class="md-nav__source">
<a href="https://github.com/BlueBrain/nexus"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
BlueBrain/nexus
</div>
</a>

</div>
<ul>
</ul>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../../../docs/architecture/meetup/markdown.html#bluebrain-nexus" class="header">BlueBrain Nexus</a>
  <ul>
    <li><a href="../../../docs/architecture/meetup/markdown.html#building-a-knowledge-graph-for-data-driven-science" class="header">Building a knowledge graph for data driven science</a>
    <ul>
      <li><a href="../../../docs/architecture/meetup/markdown.html#march-6-2019" class="header">March 6, 2019</a></li>
    </ul></li>
    <li><a href="../../../docs/architecture/meetup/markdown.html#who-we-are" class="header">Who we are</a>
    <ul>
      <li><a href="../../../docs/architecture/meetup/markdown.html#the-blue-brain-project" class="header">The Blue Brain Project</a></li>
    </ul></li>
    <li><a href="../../../docs/architecture/meetup/markdown.html#who-we-are" class="header">Who we are</a>
    <ul>
      <li><a href="../../../docs/architecture/meetup/markdown.html#two-teams" class="header">Two teams</a></li>
    </ul></li>
    <li><a href="../../../docs/architecture/meetup/markdown.html#what-do-we-do-" class="header">What do we do?</a></li>
    <li><a href="../../../docs/architecture/meetup/markdown.html#why-a-knowledge-graph-" class="header">Why a knowledge graph?</a></li>
    <li><a href="../../../docs/architecture/meetup/markdown.html#rdf-in-a-nutshell" class="header">RDF in a nutshell</a></li>
    <li><a href="../../../docs/architecture/meetup/markdown.html#n-triples" class="header">N-Triples</a></li>
    <li><a href="../../../docs/architecture/meetup/markdown.html#json-ld" class="header">JSON-LD</a></li>
    <li><a href="../../../docs/architecture/meetup/markdown.html#sparql" class="header">SPARQL</a></li>
    <li><a href="../../../docs/architecture/meetup/markdown.html#sparql" class="header">SPARQL</a></li>
    <li><a href="../../../docs/architecture/meetup/markdown.html#shacl" class="header">SHACL</a></li>
    <li><a href="../../../docs/architecture/meetup/markdown.html#in-practice" class="header">In practice</a></li>
    <li><a href="../../../docs/architecture/meetup/markdown.html#nexus-services" class="header">Nexus services</a>
    <ul>
      <li><a href="../../../docs/architecture/meetup/markdown.html#overview" class="header">Overview</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#resource-hierarchy" class="header">Resource hierarchy</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#resource-life-cycle" class="header">Resource life-cycle</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#identity-access-management" class="header">Identity &amp; access management</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#admin" class="header">Admin</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#knowledge-graph" class="header">Knowledge graph</a></li>
    </ul></li>
    <li><a href="../../../docs/architecture/meetup/markdown.html#nexus-components" class="header">Nexus components</a>
    <ul>
      <li><a href="../../../docs/architecture/meetup/markdown.html#event-sourcing-cqrs" class="header">Event sourcing &amp; CQRS</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#example-state" class="header">Example: State</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#example-command" class="header">Example: Command</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#example-event" class="header">Example: Event</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#example-evaluation" class="header">Example: Evaluation</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#example-state-machine" class="header">Example: State machine</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#example-state-machine" class="header">Example: State machine</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#example-aggregate" class="header">Example: Aggregate</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#aggregate" class="header">Aggregate</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#clustered-akka-aggregate" class="header">Clustered Akka aggregate</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#persistent-aggregate-actor" class="header">Persistent aggregate actor</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#indexing" class="header">Indexing</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#indexing" class="header">Indexing</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#indexing" class="header">Indexing</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#indexing" class="header">Indexing</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#indexing-how-its-used" class="header">Indexing: how it&rsquo;s used</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#interservice-communication" class="header">Interservice communication</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#sse-producer" class="header">SSE: producer</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#sse-consumer" class="header">SSE: consumer</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#monitoring" class="header">Monitoring</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#nexus-rdf" class="header">Nexus RDF</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#application-nexus-search" class="header">Application: Nexus Search</a></li>
    </ul></li>
    <li><a href="../../../docs/architecture/meetup/markdown.html#questions-" class="header">Questions?</a></li>
  </ul></li>
</ul>
</nav>

</nav>
<ul style="display: none">
<li class="md-nav__item md-version" id="project.version">
<label class="md-nav__link" for="__version">
<i class="md-icon" title="Version">label_outline</i> 0.1.0*
</label>
</li>
</ul>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../../../docs/architecture/meetup/markdown.html#bluebrain-nexus" class="header">BlueBrain Nexus</a>
  <ul>
    <li><a href="../../../docs/architecture/meetup/markdown.html#building-a-knowledge-graph-for-data-driven-science" class="header">Building a knowledge graph for data driven science</a>
    <ul>
      <li><a href="../../../docs/architecture/meetup/markdown.html#march-6-2019" class="header">March 6, 2019</a></li>
    </ul></li>
    <li><a href="../../../docs/architecture/meetup/markdown.html#who-we-are" class="header">Who we are</a>
    <ul>
      <li><a href="../../../docs/architecture/meetup/markdown.html#the-blue-brain-project" class="header">The Blue Brain Project</a></li>
    </ul></li>
    <li><a href="../../../docs/architecture/meetup/markdown.html#who-we-are" class="header">Who we are</a>
    <ul>
      <li><a href="../../../docs/architecture/meetup/markdown.html#two-teams" class="header">Two teams</a></li>
    </ul></li>
    <li><a href="../../../docs/architecture/meetup/markdown.html#what-do-we-do-" class="header">What do we do?</a></li>
    <li><a href="../../../docs/architecture/meetup/markdown.html#why-a-knowledge-graph-" class="header">Why a knowledge graph?</a></li>
    <li><a href="../../../docs/architecture/meetup/markdown.html#rdf-in-a-nutshell" class="header">RDF in a nutshell</a></li>
    <li><a href="../../../docs/architecture/meetup/markdown.html#n-triples" class="header">N-Triples</a></li>
    <li><a href="../../../docs/architecture/meetup/markdown.html#json-ld" class="header">JSON-LD</a></li>
    <li><a href="../../../docs/architecture/meetup/markdown.html#sparql" class="header">SPARQL</a></li>
    <li><a href="../../../docs/architecture/meetup/markdown.html#sparql" class="header">SPARQL</a></li>
    <li><a href="../../../docs/architecture/meetup/markdown.html#shacl" class="header">SHACL</a></li>
    <li><a href="../../../docs/architecture/meetup/markdown.html#in-practice" class="header">In practice</a></li>
    <li><a href="../../../docs/architecture/meetup/markdown.html#nexus-services" class="header">Nexus services</a>
    <ul>
      <li><a href="../../../docs/architecture/meetup/markdown.html#overview" class="header">Overview</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#resource-hierarchy" class="header">Resource hierarchy</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#resource-life-cycle" class="header">Resource life-cycle</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#identity-access-management" class="header">Identity &amp; access management</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#admin" class="header">Admin</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#knowledge-graph" class="header">Knowledge graph</a></li>
    </ul></li>
    <li><a href="../../../docs/architecture/meetup/markdown.html#nexus-components" class="header">Nexus components</a>
    <ul>
      <li><a href="../../../docs/architecture/meetup/markdown.html#event-sourcing-cqrs" class="header">Event sourcing &amp; CQRS</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#example-state" class="header">Example: State</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#example-command" class="header">Example: Command</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#example-event" class="header">Example: Event</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#example-evaluation" class="header">Example: Evaluation</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#example-state-machine" class="header">Example: State machine</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#example-state-machine" class="header">Example: State machine</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#example-aggregate" class="header">Example: Aggregate</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#aggregate" class="header">Aggregate</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#clustered-akka-aggregate" class="header">Clustered Akka aggregate</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#persistent-aggregate-actor" class="header">Persistent aggregate actor</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#indexing" class="header">Indexing</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#indexing" class="header">Indexing</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#indexing" class="header">Indexing</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#indexing" class="header">Indexing</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#indexing-how-its-used" class="header">Indexing: how it&rsquo;s used</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#interservice-communication" class="header">Interservice communication</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#sse-producer" class="header">SSE: producer</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#sse-consumer" class="header">SSE: consumer</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#monitoring" class="header">Monitoring</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#nexus-rdf" class="header">Nexus RDF</a></li>
      <li><a href="../../../docs/architecture/meetup/markdown.html#application-nexus-search" class="header">Application: Nexus Search</a></li>
    </ul></li>
    <li><a href="../../../docs/architecture/meetup/markdown.html#questions-" class="header">Questions?</a></li>
  </ul></li>
</ul>
</nav>

</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<div class="md-content__searchable">
<p>layout: true</p>
<div class="my-footer">
  <img src="img/EPFL_logo.svg" alt="EPFL logo" title="EPFL logo" />
  <p>Blue Brain Project | 2019</p>
</div>
<hr/>
<p>class: center, middle</p>
<h1><a href="#bluebrain-nexus" name="bluebrain-nexus" class="anchor"><span class="anchor-link"></span></a>BlueBrain Nexus</h1>
<h2><a href="#building-a-knowledge-graph-for-data-driven-science" name="building-a-knowledge-graph-for-data-driven-science" class="anchor"><span class="anchor-link"></span></a>Building a knowledge graph for data driven science</h2>
<h3><a href="#march-6-2019" name="march-6-2019" class="anchor"><span class="anchor-link"></span></a>March 6, 2019</h3>
<p>??? Hello. There&rsquo;s no linear story in this talk, I invite you to stop me and ask questions at any time.</p>
<hr/>
<h2><a href="#who-we-are" name="who-we-are" class="anchor"><span class="anchor-link"></span></a>Who we are</h2>
<h3><a href="#the-blue-brain-project" name="the-blue-brain-project" class="anchor"><span class="anchor-link"></span></a>The Blue Brain Project</h3>
<ul>
  <li>Not the Human Brain Project</li>
  <li>Own entity under EPFL governance</li>
  <li>120+ people</li>
  <li>9 sections</li>
  <li>Supercomputer at the CSCS in Lugano</li>
</ul>
<p><a href="https://bluebrain.epfl.ch">https://bluebrain.epfl.ch</a></p>
<p><a href="https://portal.bluebrain.epfl.ch">https://portal.bluebrain.epfl.ch</a></p>
<p>??? If you&rsquo;re curious about the scientific aspects of the Blue Brain, I invite you to check out our website and portal.</p>
<hr/>
<h2><a href="#who-we-are" name="who-we-are" class="anchor"><span class="anchor-link"></span></a>Who we are</h2>
<h3><a href="#two-teams" name="two-teams" class="anchor"><span class="anchor-link"></span></a>Two teams</h3>
<ul>
  <li>Neuroinformatics</li>
  <li>Back-end</li>
  <li>Front-end</li>
  <li>UI/UX</li>
  <li>Data &amp; knowledge engineering</li>
  <li>Modeling (vocabularies, taxonomies, ontologies, schemas)</li>
  <li>Literature curation</li>
  <li>Image reconstruction &amp; atlasing</li>
</ul>
<p>We build Nexus.</p>
<p>Presentation and documentation: <a href="https://bluebrain.github.io/nexus">https://bluebrain.github.io/nexus</a></p>
<p>Public instance: <a href="https://nexus-sandbox.io/web">https://nexus-sandbox.io/web</a></p>
<p>??? We&rsquo;re actually two teams. I won&rsquo;t go in too many details about how you can use, you can try out our public sandbox. In particular there&rsquo;s a tutorial that teaches you how to ingest the MovieLens dataset and run a few queries from a Python notebook.</p>
<hr/>
<h2><a href="#what-do-we-do-" name="what-do-we-do-" class="anchor"><span class="anchor-link"></span></a>What do we do?</h2>
<p><img src="img/nexus.svg" alt="nexus" title="Nexus at BBP" /></p>
<p>??? In short, Nexus&rsquo; goal is to be the platform at the center of the data gathering that drives the scientific work that is done here.</p>
<hr/>
<h2><a href="#why-a-knowledge-graph-" name="why-a-knowledge-graph-" class="anchor"><span class="anchor-link"></span></a>Why a knowledge graph?</h2>
<p><img src="img/kg1.svg" alt="example graph" title="An example graph" /></p>
<p>??? Given that there&rsquo;s no lack of databases and document stores out there, you might ask why we need a knowledge graph?</p>
<p>I&rsquo;m sure a lot of you are familiar with the concept, and here&rsquo;s a fairly simple example around a scientific article that could have been published by researchers here.</p>
<p>But first, I&rsquo;ll explain the technology a bit.</p>
<hr/>
<h2><a href="#rdf-in-a-nutshell" name="rdf-in-a-nutshell" class="anchor"><span class="anchor-link"></span></a>RDF in a nutshell</h2>
<p><img src="img/spo.svg" alt="SPO" title="Subject predicate object" /></p>
<p>??? We use semantic web, it&rsquo;s built on a pretty simple concept: and that is, relationships in the form subject - predicate - object. It&rsquo;s basic but powerful and can represent arbitrarily shaped graphs.</p>
<p>&ndash;</p>
<p>Example from <a href="https://en.wikipedia.org/wiki/Resource_Description_Framework">Wikipedia</a>:</p>
<pre class="prettyprint"><code class="language-xml">&lt;rdf:RDF xmlns:contact=&quot;http://www.w3.org/2000/10/swap/pim/contact#&quot;
         xmlns:eric=&quot;http://www.w3.org/People/EM/contact#&quot;
         xmlns:rdf=&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;&gt;
  &lt;rdf:Description rdf:about=&quot;http://www.w3.org/People/EM/contact#me&quot;&gt;
    &lt;contact:fullName&gt;Eric Miller&lt;/contact:fullName&gt;
  &lt;/rdf:Description&gt;
  &lt;rdf:Description rdf:about=&quot;http://www.w3.org/People/EM/contact#me&quot;&gt;
    &lt;contact:mailbox rdf:resource=&quot;mailto:e.miller123@example.com&quot;/&gt;
  &lt;/rdf:Description&gt;
  &lt;rdf:Description rdf:about=&quot;http://www.w3.org/People/EM/contact#me&quot;&gt;
    &lt;contact:personalTitle&gt;Dr.&lt;/contact:personalTitle&gt;
  &lt;/rdf:Description&gt;
  &lt;rdf:Description rdf:about=&quot;http://www.w3.org/People/EM/contact#me&quot;&gt;
    &lt;rdf:type rdf:resource=&quot;http://www.w3.org/2000/10/swap/pim/contact#Person&quot;/&gt;
  &lt;/rdf:Description&gt;
&lt;/rdf:RDF&gt;
</code></pre>
<p>Other representation formats: N-Triples, Turtle, JSON-LD, etc.</p>
<p>??? RDF is the original format that was designed and specified by the W3C. As you can see it&rsquo;s quite verbose. But if you look closely, you&rsquo;ll realize that subjects and predicates are URIs, and objects are either URIs and literal. Fortunately there are better representation formats.</p>
<hr/>
<h2><a href="#n-triples" name="n-triples" class="anchor"><span class="anchor-link"></span></a>N-Triples</h2>
<pre class="prettyprint"><code class="language-xml">&lt;http://www.w3.org/People/EM/contact#me&gt; &lt;http://www.w3.org/2000/10/swap/pim/contact#mailbox&gt; &lt;mailto:e.miller123@example.com&gt; .
&lt;http://www.w3.org/People/EM/contact#me&gt; &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#type&gt; &lt;http://www.w3.org/2000/10/swap/pim/contact#Person&gt; .
&lt;http://www.w3.org/People/EM/contact#me&gt; &lt;http://www.w3.org/2000/10/swap/pim/contact#fullName&gt; &quot;Eric Miller&quot; .
&lt;http://www.w3.org/People/EM/contact#me&gt; &lt;http://www.w3.org/2000/10/swap/pim/contact#personalTitle&gt; &quot;Dr.&quot; .
</code></pre>
<p>??? It&rsquo;s a bit hard to display on a slides but this format shows the subject - predicate - object relationships.</p>
<hr/>
<h2><a href="#json-ld" name="json-ld" class="anchor"><span class="anchor-link"></span></a>JSON-LD</h2>
<pre class="prettyprint"><code class="language-json">{
  &quot;@context&quot;: {
    &quot;contact&quot;: &quot;http://www.w3.org/2000/10/swap/pim/contact#&quot;,
    &quot;eric&quot;: &quot;http://www.w3.org/People/EM/contact#&quot;,
    &quot;rdf&quot;: &quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;,
    &quot;rdfs&quot;: &quot;http://www.w3.org/2000/01/rdf-schema#&quot;,
    &quot;xsd&quot;: &quot;http://www.w3.org/2001/XMLSchema#&quot;
  },
  &quot;@id&quot;: &quot;eric:me&quot;,
  &quot;@type&quot;: &quot;contact:Person&quot;,
  &quot;contact:fullName&quot;: &quot;Eric Miller&quot;,
  &quot;contact:mailbox&quot;: {
    &quot;@id&quot;: &quot;mailto:e.miller123@example.com&quot;
  },
  &quot;contact:personalTitle&quot;: &quot;Dr.&quot;
}
</code></pre>
<p>??? Here&rsquo;s the same content encoded in JSON-LD. Keys that start with an at sign are RDF specific.</p>
<hr/>
<h2><a href="#sparql" name="sparql" class="anchor"><span class="anchor-link"></span></a>SPARQL</h2>
<p>What are five names of people that published a paper in Springer, working for EPFL in Geneva?</p>
<p>??? SPARQL is the query language to access RDF data.</p>
<p>&ndash;</p>
<p><img src="img/kg2.svg" alt="example graph" title="An example graph" /></p>
<p>??? You can see on the graph the relationships needed to answer this query.</p>
<hr/>
<h2><a href="#sparql" name="sparql" class="anchor"><span class="anchor-link"></span></a>SPARQL</h2>
<pre class="prettyprint"><code class="language-sql">SELECT DISTINCT ?name
WHERE {
  ?person      a             :Person   .
  ?person      :name         ?name     .
  ?publication :author       ?person   .
  ?publication :publisher    &quot;Springer&quot;.
  ?person      :worksFor     &quot;EPFL&quot;    .
  ?person      :workLocation &quot;Geneva&quot;  .
}
LIMIT 5
</code></pre>
<p>??? And here is the actual query.</p>
<hr/>
<h2><a href="#shacl" name="shacl" class="anchor"><span class="anchor-link"></span></a>SHACL</h2>
<pre class="prettyprint"><code class="language-ttl">@prefix schema: &lt;http://schema.org/&gt; .
@prefix sh: &lt;http://www.w3.org/ns/shacl#&gt; .
@prefix xsd: &lt;http://www.w3.org/2001/XMLSchema#&gt; .

schema:PersonShape
    a sh:NodeShape ;
    sh:targetClass schema:Person ;
    sh:property [
        sh:path schema:givenName ;
        sh:datatype xsd:string ;
        sh:name &quot;given name&quot; ;
    ] ;
    sh:property [
        sh:path schema:birthDate ;
        sh:lessThan schema:deathDate ;
        sh:maxCount 1 ;
    ] ;
    sh:property [
        sh:path schema:gender ;
        sh:in ( &quot;female&quot; &quot;male&quot; ) ;
    ] ;
    sh:property [
        sh:path schema:address ;
        sh:node schema:AddressShape ;
    ] .
</code></pre>
<p>??? SHACL is a constraint language that we use to define schemas. You use Scala for strong and expressive types (or I hope, at least), this is the same thing here.</p>
<hr/>
<h2><a href="#in-practice" name="in-practice" class="anchor"><span class="anchor-link"></span></a>In practice</h2>
<p><img src="img/onto.png" alt="ontology" title="Ontology based validation" /></p>
<p>??? This shows a concrete example here at the BBP. On the left is a document that describes some experiment on a rat. On the right you see the schema that constraint the class of type Subject, it needs to have a field called &ldquo;species&rdquo;.</p>
<hr/>
<p>class: center, middle</p>
<h1><a href="#nexus-services" name="nexus-services" class="anchor"><span class="anchor-link"></span></a>Nexus services</h1>
<p>??? Now I&rsquo;m going to give a brief overview of our micro-services. Again I&rsquo;m not going to show you much of the REST API.</p>
<hr/>
<h2><a href="#overview" name="overview" class="anchor"><span class="anchor-link"></span></a>Overview</h2>
<p>.center[<img src="img/overview.svg" alt="overview" title="Nexus overview" />]</p>
<p>??? We have 3 micro-services, a couple applications and libraries that consume the API. Under the hood, we use Cassandra as our primary store, Elasticsearch, and Blazegraph, which is our triple store. And we run it on-premises in OpenShift, which is just a Kubernetes distribution. We also run the sandbox in AWS for now, but we&rsquo;ll migrate it to on-premises soon.</p>
<hr/>
<h2><a href="#resource-hierarchy" name="resource-hierarchy" class="anchor"><span class="anchor-link"></span></a>Resource hierarchy</h2>
<p>.center[<img src="img/resources-tree.svg" alt="hierarchy" title="Resource hierarchy" />]</p>
<p>??? First, we want to organize resources in our graph in different projects, that belong to an organization. You can think of GitHub organizatio and repos, it&rsquo;s pretty similar.</p>
<hr/>
<h2><a href="#resource-life-cycle" name="resource-life-cycle" class="anchor"><span class="anchor-link"></span></a>Resource life-cycle</h2>
<p><img src="img/resource-lifecycle.png" alt="lifecycle" title="Resource life-cycle" /></p>
<p>Example with resources:</p>
<pre><code>POST /v1/resources/{org_label}/{project_label}/{schema_id}
</code></pre>
<pre><code>PUT /v1/resources/{org_label}/{project_label}/{schema_id}/{resource_id}?rev={prev}
</code></pre>
<pre><code>GET /v1/resources/{org_label}/{project_label}/{schema_id}/{resource_id}
</code></pre>
<pre><code>GET /v1/resources/{org_label}/{project_label}/{schema_id}/{resource_id}?rev={rev}
</code></pre>
<pre><code>DELETE /v1/resources/{org_label}/{project_label}/{schema_id}/{resource_id}?rev={prev}
</code></pre>
<p>??? As for resources themselves, here&rsquo;s an example of a complete life-cycle. POST to create the resource, PUT to update it, then you can fetch the last revision with GET, or a specific one. And finally, DELETE to deprecate the resource, which is never really deleted.</p>
<hr/>
<h2><a href="#identity-access-management" name="identity-access-management" class="anchor"><span class="anchor-link"></span></a>Identity &amp; access management</h2>
<ul>
  <li>Authentication providers (OpenID Connect)</li>
  <li>Realms</li>
  <li>Identities</li>
  <li>Users</li>
  <li>Groups</li>
  <li>Authenticated</li>
  <li>Anonymous</li>
  <li>Permissions</li>
  <li>Arbitrary strings, e.g. <code>projects/create</code> or <code>schemas/write</code></li>
  <li>ACLs</li>
  <li>Resource path -&gt; (Identity, Permissions)</li>
</ul>
<pre class="prettyprint"><code class="language-scala">case class AccessControlLists(value: Map[Path, AccessControlList])

case class AccessControlList(value: Map[Identity, Set[Permission]])
</code></pre>
<p>??? The first service handles authentication and authorization. We support OIDC authentication providers and use Keycloak ourselves. It allows us to create ACLs. ACLs map paths in the system to pairs of identities and permissions. The service is agnostic and allows for abitrary permission strings. We can discriminate between anonymous, authenticated, or specific groups, and specific users.</p>
<hr/>
<h2><a href="#admin" name="admin" class="anchor"><span class="anchor-link"></span></a>Admin</h2>
<ul>
  <li>Organizations</li>
  <li>Projects</li>
  <li>Base</li>
  <li>Vocabulary</li>
  <li>API mappings (prefixes)</li>
</ul>
<p>.center[<img src="img/resources-tree.svg" alt="hierarchy" title="Resource hierarchy" />]</p>
<p>??? Admin is the service that manages organization and project. It store some settings for projects but that&rsquo;s not important.</p>
<hr/>
<h2><a href="#knowledge-graph" name="knowledge-graph" class="anchor"><span class="anchor-link"></span></a>Knowledge graph</h2>
<ul>
  <li>Schemas</li>
  <li>Resolvers</li>
  <li>Views</li>
  <li>Elasticsearch</li>
  <li>SPARQL</li>
  <li>Files (binary attachments)</li>
  <li>Resources</li>
</ul>
<p>??? Finally, the knowledge graph is the main service. Internally, everything is a resource. But they can have different types. We have SHACL schemas like I explained before Resolvers that define how and where to resolve IDs, for instance if you have an ID that points to a resource in another project. Views expose how the data is indexed, and an endpoint that you can query. Files are binary attachment you can add to a resource. And finally, resources, validated against a schema or not.</p>
<hr/>
<p>class: center, middle</p>
<h1><a href="#nexus-components" name="nexus-components" class="anchor"><span class="anchor-link"></span></a>Nexus components</h1>
<p>??? Now I&rsquo;m going to talk about specific components and how they&rsquo;re implemented. The goal is mostly to show you where to look in our codebase if you want to do something similar.</p>
<hr/>
<h2><a href="#event-sourcing-cqrs" name="event-sourcing-cqrs" class="anchor"><span class="anchor-link"></span></a>Event sourcing &amp; CQRS</h2>
<p><a href="https://github.com/BlueBrain/nexus-sourcing">https://github.com/BlueBrain/nexus-sourcing</a></p>
<p><img src="img/cqrs.svg" alt="event sourcing" title="Event sourcing &amp; CQRS" /></p>
<p>??? Our event sourcing is contained in a library. It doesn&rsquo;t have many dependencies and you should be able to use it as-is.</p>
<p>CQRS stands for Command and Query Responsibility Segregation. It basically segregates writes and reads. If you remember the slide a bit earlier, here Cassandra is our primary store, Elasticsearcha and Blazegraph are the indices.</p>
<hr/>
<h2><a href="#example-state" name="example-state" class="anchor"><span class="anchor-link"></span></a>Example: State</h2>
<pre class="prettyprint"><code class="language-scala">sealed trait State extends Product with Serializable

case object Initial extends State

final case class Current(
      id: Id[ProjectRef],
      rev: Long,
      types: Set[AbsoluteIri],
      deprecated: Boolean,
      tags: Map[String, Long],
      created: Instant,
      updated: Instant,
      createdBy: Subject,
      updatedBy: Subject,
      schema: Ref,
      source: Json
  ) extends State
</code></pre>
<p>??? I&rsquo;ll show you an example. This is how we handle resources in the knowledge graph. First we define a state. It has an ID, rooted in project. It has a revision, types, tags and other metadata. We store the schema it&rsquo;s validated against, and the original JSON payload.</p>
<hr/>
<h2><a href="#example-command" name="example-command" class="anchor"><span class="anchor-link"></span></a>Example: Command</h2>
<pre class="prettyprint"><code class="language-scala">sealed trait Command extends Product with Serializable {
  def id: Id[ProjectRef]
  def rev: Long
  def instant: Instant
  def subject: Subject
}
</code></pre>
<pre class="prettyprint"><code class="language-scala">final case class Create(
    id: Id[ProjectRef],
    schema: Ref,
    types: Set[AbsoluteIri],
    source: Json,
    instant: Instant,
    subject: Subject
) extends Command {
  val rev: Long = 0L
}
</code></pre>
<p>??? Now we would need to define commands, to perform actions on resources. Here&rsquo;s Create. It holds the necessary metadata that is either provided by the call, or generated, like the timestamp. We would of course also need commands for Update, Deprecate, and so on.</p>
<hr/>
<h2><a href="#example-event" name="example-event" class="anchor"><span class="anchor-link"></span></a>Example: Event</h2>
<pre class="prettyprint"><code class="language-scala">sealed trait Event extends Product with Serializable {
  def id: Id[ProjectRef]
  def rev: Long
  def instant: Instant
  def subject: Subject
}
</code></pre>
<pre class="prettyprint"><code class="language-scala">final case class Created(
    id: Id[ProjectRef],
    schema: Ref,
    types: Set[AbsoluteIri],
    source: Json,
    instant: Instant,
    subject: Subject
) extends Event {
  val rev: Long = 1L
}
</code></pre>
<p>??? Now, to implement the state machine, from a state and a command, we&rsquo;ll generate events. It looks pretty similar to the data in the command. You can see that we set the revision to 1 when a resource is created.</p>
<hr/>
<h2><a href="#example-evaluation" name="example-evaluation" class="anchor"><span class="anchor-link"></span></a>Example: Evaluation</h2>
<pre class="prettyprint"><code class="language-scala">  def eval(state: State, cmd: Command): Either[Rejection, Event] = cmd match {
      case cmd: Create =&gt; create(state, cmd)
      // Update, Deprecate, Tag, ...
    }

  def create(state: State, c: Create): Either[Rejection, Created] =
    state match {
      case Initial =&gt; Right(Created(c.id, c.schema, c.types, c.source, c.instant, c.subject))
      case _       =&gt; Left(ResourceAlreadyExists(c.id.ref))
    }
</code></pre>
<pre class="prettyprint"><code class="language-scala">class Repo[F[_]: Monad](agg: Agg[F], clock: Clock, toIdentifier: ResId =&gt; String) {

  def create(id: ResId, schema: Ref, types: Set[AbsoluteIri],
             source: Json, instant: Instant = clock.instant)(
             implicit subject: Subject): EitherT[F, Rejection, Resource] =
    evaluate(id, Create(id, schema, types, source, instant, subject))
}
</code></pre>
<p>??? We can then implement the actual logic to accept or reject a command given a state. For instance here, if you try to create a resource with an id that corresponds to an existing resource you&rsquo;ll get a rejection.</p>
<p>At the bottom I show you a component called Repo that abstracts all the operations on resources. More on that in a bit.</p>
<hr/>
<h2><a href="#example-state-machine" name="example-state-machine" class="anchor"><span class="anchor-link"></span></a>Example: State machine</h2>
<pre class="prettyprint"><code class="language-scala">def next(state: State, ev: Event): State =
  (state, ev) match {
    case (Initial, e @ Created(id, schema, types, value, tm, ident)) =&gt;
      Current(id, e.rev, types, false,
              Map.empty, None, tm, tm,
              ident, ident, schema, value)
    case (c: Current, Updated(_, rev, types, value, tm, ident)) =&gt;
      c.copy(rev = rev, types = types,
             source = value, updated = tm,
             updatedBy = ident)
    // Deprecated, TagAdded, ...
  }

</code></pre>
<p>??? Now that we have the state, command and event generation, this would be a bit of our state machine, that is used to go through the log of our event stream. If you fold over the events with this method, you&rsquo;ll get the last state.</p>
<hr/>
<h2><a href="#example-state-machine" name="example-state-machine" class="anchor"><span class="anchor-link"></span></a>Example: State machine</h2>
<p><img src="img/state-machine.svg" alt="state machine" title="State machine" /></p>
<hr/>
<h2><a href="#example-aggregate" name="example-aggregate" class="anchor"><span class="anchor-link"></span></a>Example: Aggregate</h2>
<pre class="prettyprint"><code class="language-scala">type Agg[F[_]] = Aggregate[F, String, Event, State, Command, Rejection]
</code></pre>
<pre class="prettyprint"><code class="language-scala">def aggregate[F[_]: Effect: Timer](implicit as: ActorSystem,
      mt: ActorMaterializer, sourcing: SourcingConfig, F: Monad[F]): F[Agg[F]] =
  AkkaAggregate.sharded[F](
        name = &quot;resources&quot;,
*       Initial,
*       next,
*       (state, cmd) =&gt; F.pure(eval(state, cmd)),
        sourcing.passivationStrategy,
        Retry(sourcing.retry.retryStrategy),
        sourcing.akkaSourcingConfig,
        sourcing.shards
      )
</code></pre>
<p>??? I&rsquo;ll let you look up the definition of an aggregate in domain-driven design, but in Nexus it represents resources, because that&rsquo;s the only kind of domain object we have.</p>
<p>If you remember our Repo above, this is how we create its aggregate. I&rsquo;ve highlighted the important part, namely the initial state, the next function of the state machine and the eval function that generates events.</p>
<hr/>
<h2><a href="#aggregate" name="aggregate" class="anchor"><span class="anchor-link"></span></a>Aggregate</h2>
<pre class="prettyprint"><code class="language-scala">trait Aggregate[F[_], Id, Event, State, Command, Rejection]
    extends StatefulEventLog[F, Id, Event, State] {

    def evaluate(id: Id, command: Command): F[Either[Rejection, (State, Event)]]
}
</code></pre>
<p>Using Akka cluster sharding, we construct it like this:</p>
<pre class="prettyprint"><code class="language-scala">object AkkaAggregate {

  def shardedF[F[_]: Effect, Event, State, Command, Rejection](...) = {
    val shardExtractor = { case msg: Msg =&gt;
      math.abs(msg.id.hashCode) % shards toString
    }
    val entityExtractor = { case msg: Msg =&gt; (msg.id, msg) }
    val props = AggregateActor.shardedProps(name, initialState, next,
                                            evaluate, passivationStrategy, config)
    val ref = ClusterSharding(as).start(name, props, settings,
                                        entityExtractor, shardExtractor)
    // route all messages through the sharding coordinator
    val selection = ActorRefSelection.const(ref)
    new AkkaAggregate(name, selection, retry, config)
  }
}
</code></pre>
<p>??? This is pretty specific to Akka. Since the actors will run on multiple nodes, we need a function to extract the shard in a deterministic way. Here it&rsquo;s simply using the resource ID hash code.</p>
<hr/>
<h2><a href="#clustered-akka-aggregate" name="clustered-akka-aggregate" class="anchor"><span class="anchor-link"></span></a>Clustered Akka aggregate</h2>
<pre class="prettyprint"><code class="language-scala">class AkkaAggregate[F[_]: Async, Event: ClassTag, State, Command, Rejection] (
    override val name: String,
    selection: ActorRefSelection[F],
    retry: Retry[F, Throwable],
    config: AkkaSourcingConfig,
)(implicit as: ActorSystem, mat: ActorMaterializer)
    extends Aggregate[F, String, Event, State, Command, Rejection] {

  override def evaluate(id: String, command: Command):
      F[Either[Rejection, (State, Event)]] =
    send(id, Evaluate(id, command), r =&gt; r.value)

  private def send[Reply, A](id: String, msg: Msg, f: Reply =&gt; A)
      (implicit Reply: ClassTag[Reply]): F[A] =
    selection(name, id).flatMap { ref =&gt;
*     val future = IO(ref ? msg)
      val fa     = IO.fromFuture(future).to[F]
      fa.flatMap[A] {
          case Reply(value) =&gt; F.pure(f(value))
          case e            =&gt; F.raiseError(e)
        }
        .retry
    }
}
</code></pre>
<p>??? Here I show you how it sends the Evaluate message to actor that&rsquo;s going to perform the actual evaluation. It&rsquo;s only one line really. We&rsquo;ve wrapped the futures in Cats IO so that we can use a generic effect type. In practice in our codebase, we use Monix Task.</p>
<hr/>
<h2><a href="#persistent-aggregate-actor" name="persistent-aggregate-actor" class="anchor"><span class="anchor-link"></span></a>Persistent aggregate actor</h2>
<pre class="prettyprint"><code class="language-scala">class AggregateActor[F[_]: Effect, Event, State, Command, Rejection](
    name: String,
    initialState: State,
    next: (State, Event) =&gt; State,
    evaluate: (State, Command) =&gt; F[Either[Rejection, Event]],
    passivationStrategy: PassivationStrategy[State, Command],
    config: AkkaSourcingConfig,
) extends PersistentActor with Stash with ActorLogging {

  private def evaluateCommand(cmd: Command, test: Boolean = false): Unit = {
    val eval = for {
      _ &lt;- IO.shift(config.commandEvaluationExecutionContext)
      r &lt;- evaluate(state, cmd).toIO.timeout(config.commandEvaluationMaxDuration)
      _ &lt;- IO.shift(context.dispatcher)
      _ &lt;- IO(self ! r)
    } yield ()
    val io = eval.onError { ... } // error handling
    io.unsafeRunAsyncAndForget()
  }
}
</code></pre>
<p>??? Then in the actor, we run the evaluate function. Again every future is wrapped in IO. That&rsquo;s pretty much it for writes, what about reads?</p>
<hr/>
<h2><a href="#indexing" name="indexing" class="anchor"><span class="anchor-link"></span></a>Indexing</h2>
<p><img src="img/indexing.svg" alt="indexing" title="Indexing in CQRS" /></p>
<p>??? I&rsquo;ve talked about views before. They describe and implement two things: How we index the data and where we can query it.</p>
<hr/>
<h2><a href="#indexing" name="indexing" class="anchor"><span class="anchor-link"></span></a>Indexing</h2>
<pre class="prettyprint"><code class="language-scala">case class IndexerConfig[F[_], Event, MappedEvt, Err, O &lt;: OffsetStorage](
    tag: String,
    pluginId: String,
    name: String,
    mapping: Event =&gt; F[Option[MappedEvt]],
*   index: List[MappedEvt] =&gt; F[Unit],
    init: F[Unit],
    batch: Int,
    batchTo: FiniteDuration,
    retry: Retry[F, Err],
    storage: O)
</code></pre>
<pre class="prettyprint"><code class="language-scala">trait StreamByTag[F[_], A] {

  def fetchInit: F[A]

  def source(init: A): Source[A, _]
}
</code></pre>
<p>??? To implement indexers, we need a function that will process the event, and a bunch of settings, in particular the retry mechanism and batch size. We abstract our stream of event as an Akka Source.</p>
<hr/>
<h2><a href="#indexing" name="indexing" class="anchor"><span class="anchor-link"></span></a>Indexing</h2>
<pre class="prettyprint"><code class="language-scala">class VolatileStreamByTag[F[_]: Effect, Event, MappedEvt, Err](
      config: IndexerConfig[F, Event, MappedEvt, Err, Volatile])
      extends StreamByTag[F, Offset] {

  def batchedSource(initialOffset: Offset):
        Source[(Offset, List[IdentifiedEvent]), NotUsed] = {
      val eventsByTag =
        PersistenceQuery(as)
        .readJournalFor[EventsByTagQuery](config.pluginId)
        .eventsByTag(tag, initialOffset)
      // ... casting, mapping, batching
      eventsBatched
    }

  def fetchInit: F[Offset] =
    if (config.storage.restart)
      config.init.retry *&gt; F.pure(NoOffset)
    else
      config.init.retry.flatMap(_ =&gt; projection.fetchLatestOffset.retry)
}
</code></pre>
<p>??? Here&rsquo;s an example of a stream by tag. Fetch init tries to get the initial offset based on configuration. And batchedSource will deal with all stages, from querying the primary store to transforming and grouping events.</p>
<hr/>
<h2><a href="#indexing" name="indexing" class="anchor"><span class="anchor-link"></span></a>Indexing</h2>
<pre class="prettyprint"><code class="language-scala">class VolatileStreamByTag[F[_]: Effect, Event, MappedEvt, Err](
      config: IndexerConfig[F, Event, MappedEvt, Err, Volatile])
      extends StreamByTag[F, Offset] {

  def source(initialOffset: Offset): Source[Offset, NotUsed] = {

    val eventsIndexed = batchedSource(initialOffset).mapAsync(1) {
      case (offset, events) =&gt;
        val index =
*         config.index(events.map { case (_, _, mapped) =&gt; mapped })
          .retry
          .recoverWith(recoverIndex(offset, events))
        F.toIO(index.map(_ =&gt; offset)).unsafeToFuture()
    }

    val eventsStoredProgress = eventsIndexed.mapAsync(1) { offset =&gt;
      F.toIO(projection.storeLatestOffset(offset)
      .retry
      .map(_ =&gt; offset))
      .unsafeToFuture()
    }

    eventsStoredProgress
  }
}
</code></pre>
<p>??? And here you can see the actual processing. Again, it&rsquo;s one line really It returns an Akka Source.</p>
<hr/>
<h2><a href="#indexing-how-its-used" name="indexing-how-its-used" class="anchor"><span class="anchor-link"></span></a>Indexing: how it&rsquo;s used</h2>
<ul>
  <li>Define indexers</li>
  <li>Elasticsearch</li>
  <li>Triple store (Blazegraph)</li>
  <li>Akka Distributed Data</li>
  <li>Wrap the Akka source in an coordinator actor</li>
  <li>Run the coordinator as an Akka Cluster Singleton or Cluster Sharded actor.</li>
</ul>
<hr/>
<h2><a href="#interservice-communication" name="interservice-communication" class="anchor"><span class="anchor-link"></span></a>Interservice communication</h2>
<p>We had Kafka</p>
<ul>
  <li>Easy to integrate with Alpakka Kafka</li>
  <li>Drawbacks:</li>
  <li>One more thing to operate (several nodes + ZooKeeper)</li>
  <li>Exposing event streams to external users</li>
</ul>
<p>Solution: server sent events</p>
<ul>
  <li>Support included in Akka HTTP</li>
  <li>Plain HTTP</li>
  <li>Access restriction with Nexus ACLs</li>
</ul>
<hr/>
<h2><a href="#sse-producer" name="sse-producer" class="anchor"><span class="anchor-link"></span></a>SSE: producer</h2>
<pre class="prettyprint"><code class="language-scala">val pq = PersistenceQuery(as).readJournalFor[EventsByTagQuery](queryJournalPlugin)

def source(
    tag: String,
    offset: Offset
)(implicit enc: Encoder[Event]): Source[ServerSentEvent, NotUsed] =
  pq.eventsByTag(tag, offset)
    .flatMapConcat(eventEnvelope =&gt; Source(eventToSse(eventEnvelope).toList))
    .keepAlive(10 seconds, () =&gt; ServerSentEvent.heartbeat)

def lastEventId: Directive1[Offset] =
  optionalHeaderValueByName(`Last-Event-ID`.name)
    .map(_.map(id =&gt; `Last-Event-ID`(id)))
    .flatMap {
      case Some(header) =&gt;
        Try[Offset](TimeBasedUUID(UUID.fromString(header.id)))
          .orElse(Try(Sequence(header.id.toLong))) match {
          case Success(value) =&gt; provide(value)
          case Failure(_)     =&gt; reject(validationRejection(&quot;Invalid header&quot;))
        }
      case None =&gt; provide(NoOffset)
    }
</code></pre>
<p>??? We query the primary store exactly like before. Then we have a function that transforms the event envelope. At the bottom we can see how we grab the initial offset from the HTTP headers. The client could store its offset, exactly like a Kafka consumer.</p>
<hr/>
<h2><a href="#sse-consumer" name="sse-consumer" class="anchor"><span class="anchor-link"></span></a>SSE: consumer</h2>
<pre class="prettyprint"><code class="language-scala">class EventSource[A: Decoder] {

  def send(request: HttpRequest)(
      implicit cred: Option[AuthToken]): Future[HttpResponse] =
    http.singleRequest(addCredentials(request)).map { resp =&gt;
      if (!resp.status.isSuccess())
        logger.warn(s&quot;Error when performing SSE request: &#39;${resp.status}&#39;&quot;)
      resp
    }

  def apply(iri: AbsoluteIri, offset: Option[String])(
      implicit cred: Option[AuthToken]): Source[A, NotUsed] =
*    SSESource(iri.toAkkaUri, send, offset, sseRetryDelay).flatMapConcat { sse =&gt;
      decode[A](sse.data) match {
        case Right(ev) =&gt; Source.single(ev)
        case Left(err) =&gt;
          logger.error(s&quot;Failed to decode admin event &#39;$sse&#39;&quot;, err)
          Source.empty
      }
    }
}
</code></pre>
<p>??? On the consumer side, we just need to define a function that performs the HTTP request. In our case we add the credentials. Alpakka provides that SSESource, and we decode the events with Circe.</p>
<hr/>
<h2><a href="#monitoring" name="monitoring" class="anchor"><span class="anchor-link"></span></a>Monitoring</h2>
<p>We use Kamon with two reporters:</p>
<ul>
  <li>Prometheus for metrics, plotted in Grafana</li>
  <li>Jaeger for tracing</li>
  <li>Be careful not to generate too many metrics</li>
  <li><code>operationName</code> directive creates a new histogram for every different request path</li>
  <li>Start with a reasonable sampling rate</li>
</ul>
<hr/>
<h2><a href="#nexus-rdf" name="nexus-rdf" class="anchor"><span class="anchor-link"></span></a>Nexus RDF</h2>
<p><a href="https://github.com/BlueBrain/nexus-rdf">https://github.com/BlueBrain/nexus-rdf</a></p>
<p>IRI</p>
<ul>
  <li>Superset of URI that supports unicode, used by RDF</li>
  <li>Custom parser implemented with Parboiled2</li>
  <li>Manipulation (scheme, host, port, path, segments, query, &hellip;)</li>
  <li>Conversion (absolute, relative, URL, URN, CURIE, &hellip;)</li>
</ul>
<p>Graph</p>
<ul>
  <li>Construction</li>
  <li>Manipulation</li>
  <li>Nodes</li>
  <li>Triples</li>
  <li>Serialization</li>
  <li>JSON-LD with Circe and Jena</li>
  <li>N-Triples</li>
  <li>DOT graph format</li>
</ul>
<hr/>
<h2><a href="#application-nexus-search" name="application-nexus-search" class="anchor"><span class="anchor-link"></span></a>Application: Nexus Search</h2>
<p><a href="https://bbp.epfl.ch/nexus/search/">https://bbp.epfl.ch/nexus/search/</a></p>
<hr/>
<p>class: middle, center</p>
<h1><a href="#questions-" name="questions-" class="anchor"><span class="anchor-link"></span></a>Questions?</h1>
</div>
<div>
<a href="https://github.com/BlueBrain/nexus/tree/master/src/main/paradox/docs/architecture/meetup/markdown.md" title="Edit this page" class="md-source-file md-edit">
Edit this page
</a>
</div>
<div class="print-only">
<span class="md-source-file md-version">
0.1.0*
</span>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
<div class="md-footer-copyright__highlight">
Nexus is Open Source and available under the Apache 2 License.<br/>
© 2017-2019 <a href="https://epfl.ch/">EPFL</a> | <a href="https://bluebrain.epfl.ch/">The Blue Brain Project</a>

</div>
Powered by
<a href="https://github.com/lightbend/paradox">Paradox</a>
and
<a href="https://jonas.github.io/paradox-material-theme/">Paradox Material Theme</a>

</div>
<div class="md-footer-social">
<a href="https://github.com/BlueBrain" class="md-footer-social__link fa fa-github"></a><a href="https://gitter.im/BlueBrain/nexus" class="md-footer-social__link fa fa-globe"></a>
</div>

</div>
</div>
</footer>

</div>
<script src="../../../assets/javascripts/application.583bbe55.js"></script>
<script src="../../../assets/javascripts/paradox-material-theme.js"></script>
<script>app.initialize({version:"0.17",url:{base:"../../../."}})</script>
<script type="text/javascript" src="../../../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../../../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(event) {
window.prettyPrint && prettyPrint();
});
</script>
</body>
</html>
