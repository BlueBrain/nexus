<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="description" content="docs">
<meta name="generator" content="Paradox, paradox-material-theme=0.5.1, mkdocs-material=3.0.3">

<meta name="lang:clipboard.copy" content="Copy to clipboard">
<meta name="lang:clipboard.copied" content="Copied to clipboard">
<meta name="lang:search.language" content="">
<meta name="lang:search.pipeline.stopwords" content="true">
<meta name="lang:search.pipeline.trimmer" content="true">
<meta name="lang:search.result.none" content="No matching documents">
<meta name="lang:search.result.one" content="1 matching document">
<meta name="lang:search.result.other" content="# matching documents">
<meta name="lang:search.tokenizer" content="[\s\-]+">


<meta name="description" content="docs">
<link rel="shortcut icon" href="../.././assets/img/favicon-32x32.png">
<title>v1.4 To v1.5 Migration Â· Blue Brain Nexus</title>
<link rel="stylesheet" href="../../assets/stylesheets/application.451f80e5.css">
<link rel="stylesheet" href="../../assets/stylesheets/application-palette.22915126.css">
<meta name="theme-color" content="#03a9f4" />
<link rel="stylesheet" href="../../lib/material__tabs/dist/mdc.tabs.min.css">
<link rel="stylesheet" href="../../lib/prettify/prettify.css">
<script src="../../assets/javascripts/modernizr.1aa3b519.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
<style>
body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}
code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}
</style>
<link rel="stylesheet" href="../../assets/fonts/font-awesome.css">
<link rel="stylesheet" href="../../assets/fonts/material-icons.css">
<link rel="stylesheet" href="../../assets/stylesheets/paradox-material-theme.css">
<link rel="stylesheet" href="../.././assets/css/docs.css">
</head>
<body
data-md-color-primary="light-blue"
data-md-color-accent="cyan"
>
<input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
<input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
<label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a href="../../docs/index.html" title="Blue Brain Nexus" class="md-header-nav__button md-logo">
<img src="../.././assets/img/logo.png" width="24" height="24">
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
<span class="md-header-nav__topic">
Blue Brain Nexus
</span>
<span class="md-header-nav__topic">
v1.4 To v1.5 Migration
</span>
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
<label class="md-icon md-search__icon" for="__search"></label>
<button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">&#xE5CD;</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix>
<div class="md-search-result" data-md-component="result">
<div class="md-search-result__meta">
Type to start searching
</div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>

</div>
<div class="md-flex__cell md-flex__cell--shrink">
<div class="md-header-nav__source">
<a href="https://github.com/BlueBrain/nexus"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
BlueBrain/nexus
</div>
</a>

</div>
</div>
</div>
</nav>
</header>

<div class="md-container">
<main class="md-main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0" style="visibility: hidden">
<label class="md-nav__title md-nav__title--site" for="drawer">
<a href="../../docs/index.html" title="Blue Brain Nexus" class="md-nav__button md-logo">
<span class="md-nav__button md-logo">
<img src="../.././assets/img/logo.png" width="24" height="24">
</a>
<a href="../../docs/index.html" title="Blue Brain Nexus">
Blue Brain Nexus
</a>
</label>
<div class="md-nav__source">
<a href="https://github.com/BlueBrain/nexus"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
BlueBrain/nexus
</div>
</a>

</div>
<ul>
  <li><a href="../../docs/versions.html" class="page">Versions</a></li>
  <li><a href="../../docs/getting-started/index.html" class="page">Getting Started</a>
  <ul>
    <li><a href="../../docs/getting-started/understanding-knowledge-graphs.html" class="page">Understanding Knowledge Graphs</a></li>
    <li><a href="../../docs/getting-started/try-nexus.html" class="page">Try Nexus</a></li>
    <li><a href="../../docs/getting-started/running-nexus/index.html" class="page">Running Nexus</a>
    <ul>
      <li><a href="../../docs/getting-started/running-nexus/configuration/index.html" class="page">Nexus configuration</a></li>
    </ul></li>
  </ul></li>
  <li><a href="../../docs/releases/index.html" class="page">Releases</a>
  <ul>
    <li><a href="../../docs/releases/v1.5-release-notes.html" class="page">v1.5 Release Notes</a></li>
    <li><a href="../../docs/releases/v1.4-to-v1.5-migration.html" class="active page">v1.4 To v1.5 Migration</a></li>
    <li><a href="../../docs/releases/v1.4-release-notes.html" class="page">v1.4 Release Notes</a></li>
    <li><a href="../../docs/releases/v1.3-to-v1.4-migration.html" class="page">v1.3 To v1.4 Migration</a></li>
    <li><a href="../../docs/releases/v1.3-release-notes.html" class="page">v1.3 Release Notes</a></li>
    <li><a href="../../docs/releases/v1.2-to-v1.3-migration.html" class="page">v1.2 To v1.3 Migration</a></li>
    <li><a href="../../docs/releases/v1.2-release-notes.html" class="page">v1.2 Release Notes</a></li>
    <li><a href="../../docs/releases/v1.1-release-notes.html" class="page">v1.1 Release Notes</a></li>
    <li><a href="../../docs/releases/v1.0-to-v1.1-migration.html" class="page">v1.0 To v1.1 Migration</a></li>
    <li><a href="../../docs/releases/v1.0-release-notes.html" class="page">v1.0 Release Notes</a></li>
  </ul></li>
  <li><a href="../../docs/roadmap.html" class="page">Roadmap</a></li>
  <li><a href="../../docs/fusion/index.html" class="page">Nexus Fusion</a>
  <ul>
    <li><a href="../../docs/fusion/architecture.html" class="page">Architecture</a></li>
    <li><a href="../../docs/fusion/plugins.html" class="page">Plugins</a></li>
    <li><a href="../../docs/fusion/studio.html" class="page">Studios</a></li>
    <li><a href="../../docs/fusion/search.html" class="page">Search</a></li>
    <li><a href="../../docs/fusion/admin.html" class="page">Admin</a></li>
    <li><a href="../../docs/fusion/workflow.html" class="page">Workflow (alpha)</a></li>
    <li><a href="../../docs/fusion/add-your-own-app.html" class="page">Add your own App</a></li>
  </ul></li>
  <li><a href="../../docs/forge.html" class="page">Nexus Forge</a></li>
  <li><a href="../../docs/delta/index.html" class="page">Nexus Delta</a>
  <ul>
    <li><a href="../../docs/delta/architecture.html" class="page">Architecture</a></li>
    <li><a href="../../docs/delta/api/index.html" class="page">API Reference</a>
    <ul>
      <li><a href="../../docs/delta/api/content-negotiation.html" class="page">Content Negotiation</a></li>
      <li><a href="../../docs/delta/api/error-signaling.html" class="page">Error Signaling</a></li>
      <li><a href="../../docs/delta/api/version.html" class="page">Version endpoint</a></li>
      <li><a href="../../docs/delta/api/authentication.html" class="page">Authentication &amp; Authorization</a></li>
      <li><a href="../../docs/delta/api/identities.html" class="page">Identities</a></li>
      <li><a href="../../docs/delta/api/permissions-api.html" class="page">Permissions</a></li>
      <li><a href="../../docs/delta/api/realms-api.html" class="page">Realms</a></li>
      <li><a href="../../docs/delta/api/acls-api.html" class="page">Access Control Lists</a></li>
      <li><a href="../../docs/delta/api/orgs-api.html" class="page">Organizations</a></li>
      <li><a href="../../docs/delta/api/projects-api.html" class="page">Projects</a></li>
      <li><a href="../../docs/delta/api/schemas-api.html" class="page">Schemas</a></li>
      <li><a href="../../docs/delta/api/resources-api.html" class="page">Resources</a></li>
      <li><a href="../../docs/delta/api/resolvers-api.html" class="page">Resolvers</a></li>
      <li><a href="../../docs/delta/api/views/index.html" class="page">Views</a>
      <ul>
        <li><a href="../../docs/delta/api/views/elasticsearch-view-api.html" class="page">ElasticSearchView</a></li>
        <li><a href="../../docs/delta/api/views/aggregated-es-view-api.html" class="page">AggregateElasticSearchView</a></li>
        <li><a href="../../docs/delta/api/views/sparql-view-api.html" class="page">SparqlView</a></li>
        <li><a href="../../docs/delta/api/views/aggregated-sparql-view-api.html" class="page">AggregateSparqlView</a></li>
        <li><a href="../../docs/delta/api/views/composite-view-api.html" class="page">CompositeView</a></li>
      </ul></li>
      <li><a href="../../docs/delta/api/storages-api.html" class="page">Storages</a></li>
      <li><a href="../../docs/delta/api/files-api.html" class="page">Files</a></li>
      <li><a href="../../docs/delta/api/archives-api.html" class="page">Archives</a></li>
    </ul></li>
    <li><a href="../../docs/delta/plugins/index.html" class="page">Plugins</a></li>
    <li><a href="../../docs/delta/benchmarks/index.html" class="page">Benchmarks</a>
    <ul>
      <li><a href="../../docs/delta/benchmarks/v1.4.2.html" class="page">Benchmarks v1.4.2</a></li>
      <li><a href="../../docs/delta/benchmarks/v1.2.1.html" class="page">Benchmarks v1.2.1</a></li>
    </ul></li>
  </ul></li>
  <li><a href="../../docs/utilities/index.html" class="page">Utilities</a>
  <ul>
    <li><a href="../../docs/utilities/projections.html" class="page">Indexing data in other systems</a></li>
    <li><a href="../../docs/utilities/nexus-python-cli.html" class="page">MovieLens Tutorial using the Nexus Python CLI</a></li>
  </ul></li>
  <li><a href="../../docs/faq.html" class="page">FAQ</a></li>
</ul>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../../docs/releases/v1.4-to-v1.5-migration.html#v1-4-to-v1-5-migration" class="header">v1.4 To v1.5 Migration</a>
  <ul>
    <li><a href="../../docs/releases/v1.4-to-v1.5-migration.html#requirements" class="header">Requirements</a></li>
    <li><a href="../../docs/releases/v1.4-to-v1.5-migration.html#prepare-cassandra" class="header">Prepare Cassandra</a>
    <ul>
      <li><a href="../../docs/releases/v1.4-to-v1.5-migration.html#perform-a-backup" class="header">Perform a backup</a></li>
      <li><a href="../../docs/releases/v1.4-to-v1.5-migration.html#create-a-materialized-view-on-the-messages-table-on-the-original-keyspace" class="header">Create a materialized view on the messages table on the original keyspace</a></li>
      <li><a href="../../docs/releases/v1.4-to-v1.5-migration.html#create-the-new-keyspace-for-delta-v1-5" class="header">Create the new keyspace for Delta v1.5</a></li>
      <li><a href="../../docs/releases/v1.4-to-v1.5-migration.html#check-the-materialized-view" class="header">Check the materialized view</a></li>
    </ul></li>
    <li><a href="../../docs/releases/v1.4-to-v1.5-migration.html#run-delta-in-migration-mode" class="header">Run Delta in migration mode</a>
    <ul>
      <li><a href="../../docs/releases/v1.4-to-v1.5-migration.html#pull-the-docker-image-for-delta-1-5" class="header">Pull the docker image for Delta 1.5</a></li>
      <li><a href="../../docs/releases/v1.4-to-v1.5-migration.html#configure-delta-in-migration-mode" class="header">Configure Delta in migration mode</a>
      <ul>
        <li><a href="../../docs/releases/v1.4-to-v1.5-migration.html#environment-variables-" class="header">Environment variables:</a></li>
        <li><a href="../../docs/releases/v1.4-to-v1.5-migration.html#jvm-parameters-" class="header">JVM Parameters:</a></li>
        <li><a href="../../docs/releases/v1.4-to-v1.5-migration.html#java-properties-" class="header">Java Properties:</a></li>
      </ul></li>
      <li><a href="../../docs/releases/v1.4-to-v1.5-migration.html#check-the-delta-logs" class="header">Check the delta logs</a></li>
      <li><a href="../../docs/releases/v1.4-to-v1.5-migration.html#monitor-the-health-of-the-platform" class="header">Monitor the health of the platform</a></li>
      <li><a href="../../docs/releases/v1.4-to-v1.5-migration.html#check-the-migration-progress-" class="header">Check the migration progress:</a></li>
      <li><a href="../../docs/releases/v1.4-to-v1.5-migration.html#check-the-number-of-messages-in-the-delta-1-5" class="header">Check the number of messages in the Delta 1.5</a></li>
      <li><a href="../../docs/releases/v1.4-to-v1.5-migration.html#check-the-migration-errors-warnings-" class="header">Check the migration errors/warnings:</a>
      <ul>
        <li><a href="../../docs/releases/v1.4-to-v1.5-migration.html#failures" class="header">Failures</a></li>
        <li><a href="../../docs/releases/v1.4-to-v1.5-migration.html#warnings" class="header">Warnings</a></li>
      </ul></li>
      <li><a href="../../docs/releases/v1.4-to-v1.5-migration.html#restart-in-normal-mode" class="header">Restart in normal mode</a></li>
      <li><a href="../../docs/releases/v1.4-to-v1.5-migration.html#clean-up" class="header">Clean-up</a></li>
    </ul></li>
  </ul></li>
</ul>
</nav>

</nav>
<ul style="display: none">
<li class="md-nav__item md-version" id="project.version">
<label class="md-nav__link" for="__version">
<i class="md-icon" title="Version">label_outline</i> v1.5.x
</label>
</li>
</ul>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../../docs/releases/v1.4-to-v1.5-migration.html#v1-4-to-v1-5-migration" class="header">v1.4 To v1.5 Migration</a>
  <ul>
    <li><a href="../../docs/releases/v1.4-to-v1.5-migration.html#requirements" class="header">Requirements</a></li>
    <li><a href="../../docs/releases/v1.4-to-v1.5-migration.html#prepare-cassandra" class="header">Prepare Cassandra</a>
    <ul>
      <li><a href="../../docs/releases/v1.4-to-v1.5-migration.html#perform-a-backup" class="header">Perform a backup</a></li>
      <li><a href="../../docs/releases/v1.4-to-v1.5-migration.html#create-a-materialized-view-on-the-messages-table-on-the-original-keyspace" class="header">Create a materialized view on the messages table on the original keyspace</a></li>
      <li><a href="../../docs/releases/v1.4-to-v1.5-migration.html#create-the-new-keyspace-for-delta-v1-5" class="header">Create the new keyspace for Delta v1.5</a></li>
      <li><a href="../../docs/releases/v1.4-to-v1.5-migration.html#check-the-materialized-view" class="header">Check the materialized view</a></li>
    </ul></li>
    <li><a href="../../docs/releases/v1.4-to-v1.5-migration.html#run-delta-in-migration-mode" class="header">Run Delta in migration mode</a>
    <ul>
      <li><a href="../../docs/releases/v1.4-to-v1.5-migration.html#pull-the-docker-image-for-delta-1-5" class="header">Pull the docker image for Delta 1.5</a></li>
      <li><a href="../../docs/releases/v1.4-to-v1.5-migration.html#configure-delta-in-migration-mode" class="header">Configure Delta in migration mode</a>
      <ul>
        <li><a href="../../docs/releases/v1.4-to-v1.5-migration.html#environment-variables-" class="header">Environment variables:</a></li>
        <li><a href="../../docs/releases/v1.4-to-v1.5-migration.html#jvm-parameters-" class="header">JVM Parameters:</a></li>
        <li><a href="../../docs/releases/v1.4-to-v1.5-migration.html#java-properties-" class="header">Java Properties:</a></li>
      </ul></li>
      <li><a href="../../docs/releases/v1.4-to-v1.5-migration.html#check-the-delta-logs" class="header">Check the delta logs</a></li>
      <li><a href="../../docs/releases/v1.4-to-v1.5-migration.html#monitor-the-health-of-the-platform" class="header">Monitor the health of the platform</a></li>
      <li><a href="../../docs/releases/v1.4-to-v1.5-migration.html#check-the-migration-progress-" class="header">Check the migration progress:</a></li>
      <li><a href="../../docs/releases/v1.4-to-v1.5-migration.html#check-the-number-of-messages-in-the-delta-1-5" class="header">Check the number of messages in the Delta 1.5</a></li>
      <li><a href="../../docs/releases/v1.4-to-v1.5-migration.html#check-the-migration-errors-warnings-" class="header">Check the migration errors/warnings:</a>
      <ul>
        <li><a href="../../docs/releases/v1.4-to-v1.5-migration.html#failures" class="header">Failures</a></li>
        <li><a href="../../docs/releases/v1.4-to-v1.5-migration.html#warnings" class="header">Warnings</a></li>
      </ul></li>
      <li><a href="../../docs/releases/v1.4-to-v1.5-migration.html#restart-in-normal-mode" class="header">Restart in normal mode</a></li>
      <li><a href="../../docs/releases/v1.4-to-v1.5-migration.html#clean-up" class="header">Clean-up</a></li>
    </ul></li>
  </ul></li>
</ul>
</nav>

</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<div class="md-content__searchable">
<h1><a href="#v1-4-to-v1-5-migration" name="v1-4-to-v1-5-migration" class="anchor"><span class="anchor-link"></span></a>v1.4 To v1.5 Migration</h1>
<p>The v1.5 release of Delta includes a lot of improvements like storing the compacted/expanded forms of resources to get immutability and improve performance.</p>
<p>(To have a complete list of improvements, <a href="v1.5-release-notes.html">see here</a>).</p>
<p>These improvements require to replay all existing events to a new keyspace and to reindex all data to elasticsearch/Blazegraph in order to:</p>
<ul>
  <li>Adopt the new event model for every event</li>
  <li>Detect and report broken resources in the system.</li>
</ul>
<p>Depending on the number and the complexity of existing resources and schemas in the system, the migration may last several days (about 25,000 events per hour) to complete.</p>
<p>Nonetheless, migration does not require an interruption of service of Delta 1.4 to be performed, so a double-run of delta instances is recommended during this period.</p><div class="callout note warning"><div class="callout-title">Note</div>
<p>Please do not perform any write operations on the <strong>Delta v1.5 instance</strong> as they may have an impact on the ongoing migration.</p></div>
<h2><a href="#requirements" name="requirements" class="anchor"><span class="anchor-link"></span></a>Requirements</h2>
<p>As migration requires having two coexisting keyspaces, the following allocations are recommended:</p>
<ul>
  <li>Disk space for Cassandra: 4x more disk space than the amount 1.4 is using (as we now store the compacted/expanded form of the resources)</li>
  <li>The same amount of CPU/RAM to run the instance performing migration as the one running 1.4.</li>
</ul>
<p>The migration steps are as follows:</p>
<h2><a href="#prepare-cassandra" name="prepare-cassandra" class="anchor"><span class="anchor-link"></span></a>Prepare Cassandra</h2>
<h3><a href="#perform-a-backup" name="perform-a-backup" class="anchor"><span class="anchor-link"></span></a>Perform a backup</h3>
<p>Perform a <a href="https://docs.datastax.com/en/archived/cassandra/3.0/cassandra/operations/opsBackupRestore.html" title="backup" target="_blank" rel="noopener noreferrer">backup</a> of the original keyspace <code>delta_1_4</code> and perform a repair of the Cassandra nodes:</p>
<pre><code>    nodetool repair
</code></pre>
<h3><a href="#create-a-materialized-view-on-the-messages-table-on-the-original-keyspace" name="create-a-materialized-view-on-the-messages-table-on-the-original-keyspace" class="anchor"><span class="anchor-link"></span></a>Create a materialized view on the messages table on the original keyspace</h3>
<p>Create a materialized view on the messages table on the original keyspace <code>delta_1_4</code>: </p>
<pre><code>    CREATE MATERIALIZED VIEW {delta_1_4}.ordered_messages AS
        SELECT ser_manifest, ser_id, event
        FROM delta.messages
        WHERE timebucket is not null
        AND persistence_id is not null
        AND partition_nr is not null
        AND sequence_nr is not null
        AND timestamp is not null
        PRIMARY KEY(timebucket, timestamp, persistence_id, partition_nr, sequence_nr)
        WITH CLUSTERING ORDER BY (timestamp asc);
</code></pre>
<p>The materialized view will take some time to build depending on the number of events, we will come back to it later.</p>
<h3><a href="#create-the-new-keyspace-for-delta-v1-5" name="create-the-new-keyspace-for-delta-v1-5" class="anchor"><span class="anchor-link"></span></a>Create the new keyspace for Delta v1.5</h3>
<p>Run the following command in the new keyspace for <code>delta 1_5</code>:</p>
<pre><code>    CREATE KEYSPACE IF NOT EXISTS delta_1_5
      WITH replication = {&#39;class&#39;: &#39;NetworkTopologyStrategy&#39;, &#39;datacenter1&#39;: &#39;3&#39;}  AND durable_writes = true;

    CREATE KEYSPACE IF NOT EXISTS delta_1_5_snapshot
      WITH replication = {&#39;class&#39;: &#39;NetworkTopologyStrategy&#39;, &#39;datacenter1&#39;: &#39;3&#39;}  AND durable_writes = true;

    CREATE TABLE IF NOT EXISTS delta_1_5.messages(
        persistence_id    text,
        partition_nr      bigint,
        sequence_nr       bigint,
        timestamp         timeuuid,
        timebucket        text,
        writer_uuid       text,
        ser_id            int,
        ser_manifest      text,
        event_manifest    text,
        event             blob,
        meta_ser_id       int,
        meta_ser_manifest text,
        meta              blob,
        tags              set&lt;text&gt;,
        PRIMARY KEY ((persistence_id, partition_nr), sequence_nr, timestamp))
        WITH gc_grace_seconds =864000
        AND compression = {&#39;class&#39;: &#39;LZ4Compressor&#39;}
        AND compaction = {
            &#39;class&#39; : &#39;SizeTieredCompactionStrategy&#39;,
            &#39;enabled&#39; : true,
            &#39;tombstone_compaction_interval&#39; : 86400,
            &#39;tombstone_threshold&#39; : 0.2,
            &#39;unchecked_tombstone_compaction&#39; : false,
            &#39;bucket_high&#39; : 1.5,
            &#39;bucket_low&#39; : 0.5,
            &#39;max_threshold&#39; : 32,
            &#39;min_threshold&#39; : 4,
            &#39;min_sstable_size&#39; : 50
    };

    CREATE TABLE IF NOT EXISTS delta_1_5.tag_views(
        tag_name            text,
        persistence_id      text,
        sequence_nr         bigint,
        timebucket          bigint,
        timestamp           timeuuid,
        tag_pid_sequence_nr bigint,
        writer_uuid         text,
        ser_id              int,
        ser_manifest        text,
        event_manifest      text,
        event               blob,
        meta_ser_id         int,
        meta_ser_manifest   text,
        meta                blob,
        PRIMARY KEY ((tag_name, timebucket), timestamp, persistence_id, tag_pid_sequence_nr))
        WITH gc_grace_seconds =864000
        AND compression = {&#39;class&#39;: &#39;LZ4Compressor&#39;}
        AND compaction = {
            &#39;class&#39; : &#39;SizeTieredCompactionStrategy&#39;,
            &#39;enabled&#39; : true,
            &#39;tombstone_compaction_interval&#39; : 86400,
            &#39;tombstone_threshold&#39; : 0.2,
            &#39;unchecked_tombstone_compaction&#39; : false,
            &#39;bucket_high&#39; : 1.5,
            &#39;bucket_low&#39; : 0.5,
            &#39;max_threshold&#39; : 32,
            &#39;min_threshold&#39; : 4,
            &#39;min_sstable_size&#39; : 50
    };

    CREATE TABLE IF NOT EXISTS delta_1_5.tag_write_progress(
        persistence_id      text,
        tag                 text,
        sequence_nr         bigint,
        tag_pid_sequence_nr bigint,
        offset              timeuuid,
        PRIMARY KEY (persistence_id, tag)
    );

    CREATE TABLE IF NOT EXISTS delta_1_5.tag_scanning(
        persistence_id text,
        sequence_nr    bigint,
        PRIMARY KEY (persistence_id)
    );

    CREATE TABLE IF NOT EXISTS delta_1_5.metadata(
        persistence_id text PRIMARY KEY,
        deleted_to     bigint,
        properties     map&lt;text,text&gt;
    );

    CREATE TABLE IF NOT EXISTS delta_1_5.all_persistence_ids(
        persistence_id text PRIMARY KEY
    );

    CREATE TABLE IF NOT EXISTS delta_1_5_snapshot.snapshots(
        persistence_id    text,
        sequence_nr       bigint,
        timestamp         bigint,
        ser_id            int,
        ser_manifest      text,
        snapshot_data     blob,
        snapshot          blob,
        meta_ser_id       int,
        meta_ser_manifest text,
        meta              blob,
        PRIMARY KEY (persistence_id, sequence_nr))
        WITH CLUSTERING ORDER BY (sequence_nr DESC) AND gc_grace_seconds =864000
        AND compression = {&#39;class&#39;: &#39;LZ4Compressor&#39;}
        AND compaction = {
        &#39;class&#39; : &#39;SizeTieredCompactionStrategy&#39;,
        &#39;enabled&#39; : true,
        &#39;tombstone_compaction_interval&#39; : 86400,
        &#39;tombstone_threshold&#39; : 0.2,
        &#39;unchecked_tombstone_compaction&#39; : false,
        &#39;bucket_high&#39; : 1.5,
        &#39;bucket_low&#39; : 0.5,
        &#39;max_threshold&#39; : 32,
        &#39;min_threshold&#39; : 4,
        &#39;min_sstable_size&#39; : 50
    };

    CREATE TABLE IF NOT EXISTS delta_1_5.projections_progress(
        projection_id text primary key,
        offset              timeuuid,
        timestamp           bigint,
        processed           bigint,
        discarded           bigint,
        warnings            bigint,
        failed              bigint,
        value               text,
        value_timestamp     bigint,
    );

    CREATE TABLE IF NOT EXISTS delta_1_5.projections_errors(
        projection_id  text,
        offset         timeuuid,
        timestamp      bigint,
        persistence_id text,
        sequence_nr    bigint,
        value          text,
        value_timestamp     bigint,
        severity       text,
        error_type     text,
        message        text,
        PRIMARY KEY ((projection_id), timestamp, persistence_id, sequence_nr))
        WITH CLUSTERING ORDER BY (timestamp ASC, persistence_id ASC, sequence_nr ASC)
        AND compression = {&#39;class&#39;: &#39;LZ4Compressor&#39;};
</code></pre>
<p>Note that <a href="https://cassandra.apache.org/doc/3.11.8/operating/compression.html" title="compression" target="_blank" rel="noopener noreferrer">compression</a> has been added in v1.5.</p>
<h3><a href="#check-the-materialized-view" name="check-the-materialized-view" class="anchor"><span class="anchor-link"></span></a>Check the materialized view</h3>
<p>These operations may take a while to complete depending on the number of rows in the messages table.</p>
<ul>
  <li>
    <p>On the messages table:</p>
    <pre><code>cqlsh -e &#39;select timebucket from delta.messages&#39; | grep rows
</code></pre>
  </li>
  <li>
    <p>On the materialized view:</p>
    <pre><code>cqlsh -e &#39;select timebucket from delta.ordered_messages&#39; | grep rows
</code></pre>
  </li>
</ul>
<p>When the materialized view has the same number of rows as the table then it is ready for migration.</p>
<h2><a href="#run-delta-in-migration-mode" name="run-delta-in-migration-mode" class="anchor"><span class="anchor-link"></span></a>Run Delta in migration mode</h2>
<h3><a href="#pull-the-docker-image-for-delta-1-5" name="pull-the-docker-image-for-delta-1-5" class="anchor"><span class="anchor-link"></span></a>Pull the docker image for Delta 1.5</h3>
<p>Pull the docker image for Delta 1.5 from <a href="https://hub.docker.com/r/bluebrain/nexus-delta" title="Docker Hub">Docker Hub</a></p>
<pre><code>    docker pull bluebrain/nexus-delta:1.5.x
</code></pre>
<h3><a href="#configure-delta-in-migration-mode" name="configure-delta-in-migration-mode" class="anchor"><span class="anchor-link"></span></a>Configure Delta in migration mode</h3>
<p>This section defines the mandatory configuration to run Delta in migration mode.</p>
<h4><a href="#environment-variables-" name="environment-variables-" class="anchor"><span class="anchor-link"></span></a>Environment variables:</h4>
<ul>
  <li>KAMON_ENABLED: false (not mandatory but recommended)</li>
  <li>MIGRATE_DATA: true</li>
  <li>SCHEMA_VALIDATION_DISABLED: &ldquo;true&rdquo;</li>
  <li>DISABLE_INDEXING: &ldquo;true&rdquo;</li>
  <li>DELTA_PLUGINS: /opt/docker/plugins/</li>
</ul>
<h4><a href="#jvm-parameters-" name="jvm-parameters-" class="anchor"><span class="anchor-link"></span></a>JVM Parameters:</h4>
<ul>
  <li>Adopt the same values as the one for your current deployment</li>
</ul>
<h4><a href="#java-properties-" name="java-properties-" class="anchor"><span class="anchor-link"></span></a>Java Properties:</h4>
<table>
  <thead>
    <tr>
      <th>Description </th>
      <th>Property </th>
      <th>Example value </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Service binding interface </td>
      <td>app.http.interface </td>
      <td>0.0.0.0 </td>
    </tr>
    <tr>
      <td>Service Uri Path prefix </td>
      <td>app.http.base-uri </td>
      <td>{delta-url}:8080/v1 </td>
    </tr>
    <tr>
      <td>Cassandra contact point (1) </td>
      <td>app.database.cassandra.contact-points.1 </td>
      <td>cassandra-1:9042 </td>
    </tr>
    <tr>
      <td>Cassandra contact point (2) </td>
      <td>app.database.cassandra.contact-points.2 </td>
      <td>cassandra-2:9042 </td>
    </tr>
    <tr>
      <td>Cassandra contact point (3) </td>
      <td>app.database.cassandra.contact-points.3 </td>
      <td>cassandra-3:9042 </td>
    </tr>
    <tr>
      <td>Cassandra username </td>
      <td>app.database.cassandra.username </td>
      <td> </td>
    </tr>
    <tr>
      <td>Cassandra password </td>
      <td>app.database.cassandra.password </td>
      <td> </td>
    </tr>
    <tr>
      <td>Cassandra timeout </td>
      <td>datastax-java-driver.basic.request.timeout </td>
      <td>10 seconds </td>
    </tr>
    <tr>
      <td>Secrets encryption password </td>
      <td>app.encryption.password </td>
      <td> </td>
    </tr>
    <tr>
      <td>Secrets encryption salt </td>
      <td>app.encryption.salt </td>
      <td> </td>
    </tr>
    <tr>
      <td>Remote storage enabling </td>
      <td>plugins.storage.storages.remote-disk.enabled </td>
      <td>true/false </td>
    </tr>
    <tr>
      <td>S3 storage enabling </td>
      <td>plugins.storage.storages.amazon.enabled </td>
      <td>true/false </td>
    </tr>
    <tr>
      <td>Delta 1.4 keyspace </td>
      <td>migration.replay.keyspace </td>
      <td>delta </td>
    </tr>
    <tr>
      <td>Bucket of the first event </td>
      <td>migration.replay.first-time-bucket </td>
      <td>YYYYMMDDTHH:MM (Same as the one on your Delta 1.4 deployment) </td>
    </tr>
  </tbody>
</table>
<p>Start Delta 1.5 with this configuration.</p>
<h3><a href="#check-the-delta-logs" name="check-the-delta-logs" class="anchor"><span class="anchor-link"></span></a>Check the delta logs</h3>
<ul>
  <li>The following messages indicating migration should appear at startup:
    <pre><code>2021-05-05 14:34:42 INFO  ch.epfl.bluebrain.nexus.delta.Main - Plugins discovered: blazegraph-1.5.xxx, elasticsearch-1.5.xxx, storage-1.5.xxx, composite-views-1.5.xxx, archive-1.5.xxx
2021-05-05 14:34:46 INFO  ch.epfl.bluebrain.nexus.delta.Main - Starting Delta in migration mode
</code></pre>
  </li>
</ul>
<p>If remote/S3 storage are enabled, these lines should appear too:</p>
<pre><code>    2021-05-05 14:35:00 INFO  c.e.b.n.d.p.s.StoragePluginConfig - Remote-disk storage is enabled
</code></pre>
<p>Keep looking regularly in the logs to look if the migration is still ongoing without problems. If the migration crashes, a restart should allow it to start back from where it stopped.</p>
<h3><a href="#monitor-the-health-of-the-platform" name="monitor-the-health-of-the-platform" class="anchor"><span class="anchor-link"></span></a>Monitor the health of the platform</h3>
<p>Please check the general health of the platform (especially Cassandra available disk space).</p>
<h3><a href="#check-the-migration-progress-" name="check-the-migration-progress-" class="anchor"><span class="anchor-link"></span></a>Check the migration progress:</h3>
<p>Run the following query on table projections_progress in cqlsh (or your favorite cql client):</p>
<pre><code>    select projection_id, processed, failed, warnings, toTimestamp(offset) as migratedUpTo, timestamp from delta_1_5.projections_progress;
</code></pre>
<p>This will return a similar response:</p>
<pre><code>    projection_id  | processed | failed | warnings | migratedupto
    -----------+--------+----------+--------------------------------------------------
    migration-v1.5 |     38499 |  10000 |       12 | 2019-04-10 08:53:01.482000+0000 
</code></pre>
<p>The table contains the following information:</p>
<ul>
  <li>processed: total number of processed events</li>
  <li>failed: number of failures risen during the migration</li>
  <li>warnings: number of warnings risen during the migration</li>
  <li>migratedUpTo: timestamp of the last event processed by migration when migration last saved progress</li>
</ul>
<p>Once Migration terminates, the sum of the processed and failed columns should be equal to the number of events in your Delta 1.4 deployment.</p>
<p>When looking at the logs, these lines should be also repeated (the timestamp should match the current date/hour):</p>
<pre><code>    2021-05-06 04:00:20 INFO  c.e.b.n.m.replay.ReplayMessageEvents - Next offset is 25683800-ae17-11eb-8080-808080808080 (2021-05-06 03:00:00:000)
    2021-05-06 04:00:20 INFO  c.e.b.n.m.replay.ReplayMessageEvents - We got 0 rows
</code></pre>
<h3><a href="#check-the-number-of-messages-in-the-delta-1-5" name="check-the-number-of-messages-in-the-delta-1-5" class="anchor"><span class="anchor-link"></span></a>Check the number of messages in the Delta 1.5</h3>
<p>These operations may take a while to complete but they should give the same result (minus the errors that may have happened)</p>
<ul>
  <li>
    <p>On the Delta messages table:</p>
    <pre><code>cqlsh -e &#39;select timebucket from delta.messages&#39; | grep rows
</code></pre>
  </li>
  <li>
    <p>On the Delta 1.5 message table:</p>
    <pre><code>cqlsh -e &#39;select timebucket from delta_1_5.messages&#39; | grep rows
</code></pre>
  </li>
</ul>
<h3><a href="#check-the-migration-errors-warnings-" name="check-the-migration-errors-warnings-" class="anchor"><span class="anchor-link"></span></a>Check the migration errors/warnings:</h3>
<p>The errors/warnings are reported in the projections_errors table.</p>
<p>There are two types of errors:</p>
<h4><a href="#failures" name="failures" class="anchor"><span class="anchor-link"></span></a>Failures</h4>
<p>The event could not be migrated for the given reason:</p>
<ul>
  <li>Invalid data due to previous bugs in Delta (invalid iris, acl paths, &hellip;)</li>
  <li>Revision error as a previous revision has been rejected</li>
</ul>
<p>There should be very few of them, and their resolution should be addressed in a process that is beyond the scope of migration.</p>
<h4><a href="#warnings" name="warnings" class="anchor"><span class="anchor-link"></span></a>Warnings</h4>
<p>The event could be migrated, but a fix had to be performed on the event source (original payload posted by the user). Example:</p>
<ul>
  <li>When an id in the source can&rsquo;t be resolved to match the one computed in v1.4, it is overwritten by this id</li>
</ul>
<p>The errors table contains the following information:</p>
<ul>
  <li>projection_id: the id of the projection (migration-v1.5)</li>
  <li>timestamp: when the error was risen</li>
  <li>persistence_id: the internal id of the event in v1.4</li>
  <li>sequence_nr: the sequence number of the event in v1.4</li>
  <li>offset: the offset of the event in v1.4</li>
  <li>error_type: the type of error</li>
  <li>message: the message and the context of the error</li>
  <li>severity: the level of error (Failure or Warning as explaining above)</li>
</ul>
<p>To get the errors:</p>
<pre><code>    select * from delta_1_5.projections_errors;
</code></pre>
<p>Note that Cassandra allows you to export table as a CSV file which could be useful if you want to share, process or filter them.</p>
<pre><code>    copy delta_1_5.projections_errors to &#39;/path/file.csv&#39;
</code></pre>
<p>To get a better clue at the error, check the resource in your running v1.4 deployment and or read the event in the delta v1.4 table:</p>
<pre><code>    select blobAsText(event) from {delta_1_4}.messages where persistence_id = &#39;{persistence_id}&#39; and sequence_nr={sequence_nr} and partition_nr =0;
</code></pre>
<h3><a href="#restart-in-normal-mode" name="restart-in-normal-mode" class="anchor"><span class="anchor-link"></span></a>Restart in normal mode</h3>
<p>Once migration is completed and the previous checks have been performed, Delta can be restarted in normal mode.</p>
<p>The previous Delta instance can be stopped. After the restart, a complete reindexing of the data in elasticsearch/blazegraph will take place. </p>
<ul>
  <li>Stop the Delta 1.4 instance ;</li>
  <li>Delete all ElasticSearch indices:
    <pre><code>curl -XDELETE &#39;http://{elasticsearch_host}/delta_*&#39;
</code></pre>
  </li>
  <li>
    <p>Delete all BlazeGraph namespaces:</p>
    <pre><code>for i in `curl -s &#39;http://{blazegraph_host}/blazegraph/namespace?describe-each-named-graph=false&#39; | grep sparqlEndpoint | grep -o --color &quot;rdf:resource=\&quot;[^\&quot;]*&quot; | sed &#39;s/rdf:resource=&quot;//&#39; | sed &#39;s#/sparql$##&#39; | grep -v kb | grep -v LBS`
   do curl -X DELETE &quot;$i&quot;
done
</code></pre>
  </li>
  <li>
  <p>Restart the Delta v1.5 instance in normal mode according to the Delta v1.5 <a href="../getting-started/running-nexus/index.html">deployment documentation</a> and by removing the environment variables MIGRATE_DATA, SCHEMA_VALIDATION_DISABLED and DISABLE_INDEXING.</p></li>
  <li>Check the delta logs after restart</li>
  <li>
  <p>As the entire indexing will take place, some timeouts may occur</p></li>
  <li>Leaving kamon disabled (environment variable KAMON_ENABLED set to false) during this indexing is recommended</li>
  <li>Allocating temporarily more resources to Cassandra/Delta/elasticsearch/Blazegraph may help as this part is greedy in resources</li>
  <li>Increasing temporarily the delay in retry strategies can also help reduce the pressure on the platform. See: <a href="https://github.com/BlueBrain/nexus/blob/v1.5.0/delta/app/src/main/resources/app.conf#L294" title="Delta configuration">Delta configuration</a></li>
  <li>
  <p>Check the statistics views for different views, they should progressively tend to get to 0 remaining events.</p></li>
  <li>Check the cluster stats endpoint in <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-stats.html" title="elasticsearch">elasticsearch</a>, the number of indices and docs should stabilize after a while.</li>
  <li>When indexing is finished, the CPU/memory used by the platform should decrease.</li>
</ul>
<h3><a href="#clean-up" name="clean-up" class="anchor"><span class="anchor-link"></span></a>Clean-up</h3>
<ul>
  <li>
    <p>Once Delta v1.5 is up and running, you can delete the old keyspace:</p>
    <pre><code>DROP KEYSPACE {delta_1_4};
</code></pre>
  </li>
  <li>
  <p>The old Delta v1.4 instance can also be removed.</p></li>
  <li>Reverse the temporary resources / configuration changes that were needed for global reindexing.</li>
</ul>
</div>
<div>
<a href="https://github.com/BlueBrain/nexus/tree/master/docs/src/main/paradox/docs/releases/v1.4-to-v1.5-migration.md" title="Edit this page" class="md-source-file md-edit">
Edit this page
</a>
</div>
<div class="print-only">
<span class="md-source-file md-version">
v1.5.x
</span>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a href="../../docs/releases/v1.5-release-notes.html" title="v1.5 Release Notes" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Previous
</span>
v1.5 Release Notes
</span>
</div>
</a>
<a href="../../docs/releases/v1.4-release-notes.html" title="v1.4 Release Notes" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Next
</span>
v1.4 Release Notes
</span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
<div class="md-footer-copyright__highlight">
Nexus is Open Source and available under the Apache 2 License.<br/>
Â© 2017-2021 <a href="https://epfl.ch/">EPFL</a> | <a href="https://bluebrain.epfl.ch/">The Blue Brain Project</a>

</div>
</div>
<div class="md-footer-social">
<a href="https://github.com/BlueBrain" class="md-footer-social__link fa fa-github"></a><a href="https://github.com/BlueBrain/nexus/discussions" class="md-footer-social__link fa fa-github"></a>
</div>

</div>
</div>
</footer>

</div>
<script src="../../assets/javascripts/application.583bbe55.js"></script>
<script src="../../assets/javascripts/paradox-material-theme.js"></script>
<script>app.initialize({version:"0.17",url:{base:"../../."}})</script>
<script type="text/javascript" src="../../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(event) {
window.prettyPrint && prettyPrint();
});
</script>
<script src="../.././public/js/gtm.js"></script>
</body>
</html>
