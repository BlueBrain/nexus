{"version":3,"file":"observe-rect.cjs.production.min.js","sources":["../src/index.ts"],"sourcesContent":["let props: (keyof DOMRect)[] = [\n\t\"bottom\",\n\t\"height\",\n\t\"left\",\n\t\"right\",\n\t\"top\",\n\t\"width\",\n];\n\nlet rectChanged = (a: DOMRect = {} as DOMRect, b: DOMRect = {} as DOMRect) =>\n\tprops.some((prop) => a[prop] !== b[prop]);\n\nlet observedNodes = new Map<Element, RectProps>();\nlet rafId: number;\n\nlet run = () => {\n\tconst changedStates: RectProps[] = [];\n\tobservedNodes.forEach((state, node) => {\n\t\tlet newRect = node.getBoundingClientRect();\n\t\tif (rectChanged(newRect, state.rect)) {\n\t\t\tstate.rect = newRect;\n\t\t\tchangedStates.push(state);\n\t\t}\n\t});\n\n\tchangedStates.forEach((state) => {\n\t\tstate.callbacks.forEach((cb) => cb(state.rect));\n\t});\n\n\trafId = window.requestAnimationFrame(run);\n};\n\nexport default function observeRect(\n\tnode: Element,\n\tcb: (rect: DOMRect) => void\n) {\n\treturn {\n\t\tobserve() {\n\t\t\tlet wasEmpty = observedNodes.size === 0;\n\t\t\tif (observedNodes.has(node)) {\n\t\t\t\tobservedNodes.get(node)!.callbacks.push(cb);\n\t\t\t} else {\n\t\t\t\tobservedNodes.set(node, {\n\t\t\t\t\trect: undefined,\n\t\t\t\t\thasRectChanged: false,\n\t\t\t\t\tcallbacks: [cb],\n\t\t\t\t});\n\t\t\t}\n\t\t\tif (wasEmpty) run();\n\t\t},\n\n\t\tunobserve() {\n\t\t\tlet state = observedNodes.get(node);\n\t\t\tif (state) {\n\t\t\t\t// Remove the callback\n\t\t\t\tconst index = state.callbacks.indexOf(cb);\n\t\t\t\tif (index >= 0) state.callbacks.splice(index, 1);\n\n\t\t\t\t// Remove the node reference\n\t\t\t\tif (!state.callbacks.length) observedNodes.delete(node);\n\n\t\t\t\t// Stop the loop\n\t\t\t\tif (!observedNodes.size) cancelAnimationFrame(rafId);\n\t\t\t}\n\t\t},\n\t};\n}\n\nexport type PartialRect = Partial<DOMRect>;\n\nexport type RectProps = {\n\trect: DOMRect | undefined;\n\thasRectChanged: boolean;\n\tcallbacks: Function[];\n};\n"],"names":["rafId","props","observedNodes","Map","node","cb","observe","wasEmpty","size","has","get","callbacks","push","set","rect","undefined","hasRectChanged","run","changedStates","forEach","state","a","b","newRect","getBoundingClientRect","some","prop","window","requestAnimationFrame","unobserve","index","indexOf","splice","length","cancelAnimationFrame"],"mappings":"oEAAA,IAaIA,EAbAC,EAA2B,CAC9B,SACA,SACA,OACA,QACA,MACA,SAMGC,EAAgB,IAAIC,6BAqBvBC,EACAC,SAEO,CACNC,uBACKC,EAAkC,IAAvBL,EAAcM,KACzBN,EAAcO,IAAIL,GACrBF,EAAcQ,IAAIN,GAAOO,UAAUC,KAAKP,GAExCH,EAAcW,IAAIT,EAAM,CACvBU,UAAMC,EACNC,gBAAgB,EAChBL,UAAW,CAACN,KAGVE,GAjCG,SAANU,QACGC,EAA6B,GACnChB,EAAciB,SAAQ,SAACC,EAAOhB,OARZiB,EAA4BC,EASzCC,EAAUnB,EAAKoB,kCATFH,EAUDE,KAVCF,EAAa,cAAeC,EAUpBF,EAAMN,QAVcQ,EAAa,IAC3DrB,EAAMwB,MAAK,SAACC,UAASL,EAAEK,KAAUJ,EAAEI,QAUjCN,EAAMN,KAAOS,EACbL,EAAcN,KAAKQ,OAIrBF,EAAcC,SAAQ,SAACC,GACtBA,EAAMT,UAAUQ,SAAQ,SAACd,UAAOA,EAAGe,EAAMN,YAG1Cd,EAAQ2B,OAAOC,sBAAsBX,GAmBrBA,IAGfY,yBACKT,EAAQlB,EAAcQ,IAAIN,MAC1BgB,EAAO,KAEJU,EAAQV,EAAMT,UAAUoB,QAAQ1B,GAClCyB,GAAS,GAAGV,EAAMT,UAAUqB,OAAOF,EAAO,GAGzCV,EAAMT,UAAUsB,QAAQ/B,SAAqBE,GAG7CF,EAAcM,MAAM0B,qBAAqBlC"}