{"version":3,"file":"observe-rect.umd.development.js","sources":["../src/index.ts"],"sourcesContent":["let props: (keyof DOMRect)[] = [\n\t\"bottom\",\n\t\"height\",\n\t\"left\",\n\t\"right\",\n\t\"top\",\n\t\"width\",\n];\n\nlet rectChanged = (a: DOMRect = {} as DOMRect, b: DOMRect = {} as DOMRect) =>\n\tprops.some((prop) => a[prop] !== b[prop]);\n\nlet observedNodes = new Map<Element, RectProps>();\nlet rafId: number;\n\nlet run = () => {\n\tconst changedStates: RectProps[] = [];\n\tobservedNodes.forEach((state, node) => {\n\t\tlet newRect = node.getBoundingClientRect();\n\t\tif (rectChanged(newRect, state.rect)) {\n\t\t\tstate.rect = newRect;\n\t\t\tchangedStates.push(state);\n\t\t}\n\t});\n\n\tchangedStates.forEach((state) => {\n\t\tstate.callbacks.forEach((cb) => cb(state.rect));\n\t});\n\n\trafId = window.requestAnimationFrame(run);\n};\n\nexport default function observeRect(\n\tnode: Element,\n\tcb: (rect: DOMRect) => void\n) {\n\treturn {\n\t\tobserve() {\n\t\t\tlet wasEmpty = observedNodes.size === 0;\n\t\t\tif (observedNodes.has(node)) {\n\t\t\t\tobservedNodes.get(node)!.callbacks.push(cb);\n\t\t\t} else {\n\t\t\t\tobservedNodes.set(node, {\n\t\t\t\t\trect: undefined,\n\t\t\t\t\thasRectChanged: false,\n\t\t\t\t\tcallbacks: [cb],\n\t\t\t\t});\n\t\t\t}\n\t\t\tif (wasEmpty) run();\n\t\t},\n\n\t\tunobserve() {\n\t\t\tlet state = observedNodes.get(node);\n\t\t\tif (state) {\n\t\t\t\t// Remove the callback\n\t\t\t\tconst index = state.callbacks.indexOf(cb);\n\t\t\t\tif (index >= 0) state.callbacks.splice(index, 1);\n\n\t\t\t\t// Remove the node reference\n\t\t\t\tif (!state.callbacks.length) observedNodes.delete(node);\n\n\t\t\t\t// Stop the loop\n\t\t\t\tif (!observedNodes.size) cancelAnimationFrame(rafId);\n\t\t\t}\n\t\t},\n\t};\n}\n\nexport type PartialRect = Partial<DOMRect>;\n\nexport type RectProps = {\n\trect: DOMRect | undefined;\n\thasRectChanged: boolean;\n\tcallbacks: Function[];\n};\n"],"names":["props","rectChanged","a","b","some","prop","observedNodes","Map","rafId","run","changedStates","forEach","state","node","newRect","getBoundingClientRect","rect","push","callbacks","cb","window","requestAnimationFrame","observeRect","observe","wasEmpty","size","has","get","set","undefined","hasRectChanged","unobserve","index","indexOf","splice","length","cancelAnimationFrame"],"mappings":";;;;;;CAAA,IAAIA,KAAK,GAAsB,CAC9B,QAD8B,EAE9B,QAF8B,EAG9B,MAH8B,EAI9B,OAJ8B,EAK9B,KAL8B,EAM9B,OAN8B,CAA/B;;CASA,IAAIC,WAAW,GAAG,SAAdA,WAAc,CAACC,CAAD,EAA6BC,CAA7B;CAAA,MAACD,CAAD;CAACA,IAAAA,CAAD,GAAc,EAAd;CAAA;;CAAA,MAA6BC,CAA7B;CAA6BA,IAAAA,CAA7B,GAA0C,EAA1C;CAAA;;CAAA,SACjBH,KAAK,CAACI,IAAN,CAAW,UAACC,IAAD;CAAA,WAAUH,CAAC,CAACG,IAAD,CAAD,KAAYF,CAAC,CAACE,IAAD,CAAvB;CAAA,GAAX,CADiB;CAAA,CAAlB;;CAGA,IAAIC,aAAa,gBAAG,IAAIC,GAAJ,EAApB;CACA,IAAIC,KAAJ;;CAEA,IAAIC,GAAG,GAAG,SAANA,GAAM;CACT,MAAMC,aAAa,GAAgB,EAAnC;CACAJ,EAAAA,aAAa,CAACK,OAAd,CAAsB,UAACC,KAAD,EAAQC,IAAR;CACrB,QAAIC,OAAO,GAAGD,IAAI,CAACE,qBAAL,EAAd;;CACA,QAAId,WAAW,CAACa,OAAD,EAAUF,KAAK,CAACI,IAAhB,CAAf,EAAsC;CACrCJ,MAAAA,KAAK,CAACI,IAAN,GAAaF,OAAb;CACAJ,MAAAA,aAAa,CAACO,IAAd,CAAmBL,KAAnB;CACA;CACD,GAND;CAQAF,EAAAA,aAAa,CAACC,OAAd,CAAsB,UAACC,KAAD;CACrBA,IAAAA,KAAK,CAACM,SAAN,CAAgBP,OAAhB,CAAwB,UAACQ,EAAD;CAAA,aAAQA,EAAE,CAACP,KAAK,CAACI,IAAP,CAAV;CAAA,KAAxB;CACA,GAFD;CAIAR,EAAAA,KAAK,GAAGY,MAAM,CAACC,qBAAP,CAA6BZ,GAA7B,CAAR;CACA,CAfD;;UAiBwBa,YACvBT,MACAM;CAEA,SAAO;CACNI,IAAAA,OADM;CAEL,UAAIC,QAAQ,GAAGlB,aAAa,CAACmB,IAAd,KAAuB,CAAtC;;CACA,UAAInB,aAAa,CAACoB,GAAd,CAAkBb,IAAlB,CAAJ,EAA6B;CAC5BP,QAAAA,aAAa,CAACqB,GAAd,CAAkBd,IAAlB,EAAyBK,SAAzB,CAAmCD,IAAnC,CAAwCE,EAAxC;CACA,OAFD,MAEO;CACNb,QAAAA,aAAa,CAACsB,GAAd,CAAkBf,IAAlB,EAAwB;CACvBG,UAAAA,IAAI,EAAEa,SADiB;CAEvBC,UAAAA,cAAc,EAAE,KAFO;CAGvBZ,UAAAA,SAAS,EAAE,CAACC,EAAD;CAHY,SAAxB;CAKA;;CACD,UAAIK,QAAJ,EAAcf,GAAG;CACjB,KAbK;CAeNsB,IAAAA,SAfM;CAgBL,UAAInB,KAAK,GAAGN,aAAa,CAACqB,GAAd,CAAkBd,IAAlB,CAAZ;;CACA,UAAID,KAAJ,EAAW;CACV;CACA,YAAMoB,KAAK,GAAGpB,KAAK,CAACM,SAAN,CAAgBe,OAAhB,CAAwBd,EAAxB,CAAd;CACA,YAAIa,KAAK,IAAI,CAAb,EAAgBpB,KAAK,CAACM,SAAN,CAAgBgB,MAAhB,CAAuBF,KAAvB,EAA8B,CAA9B,EAHN;;CAMV,YAAI,CAACpB,KAAK,CAACM,SAAN,CAAgBiB,MAArB,EAA6B7B,aAAa,UAAb,CAAqBO,IAArB,EANnB;;CASV,YAAI,CAACP,aAAa,CAACmB,IAAnB,EAAyBW,oBAAoB,CAAC5B,KAAD,CAApB;CACzB;CACD;CA5BK,GAAP;CA8BA;;;;;;;;;;;;"}