{"version":3,"sources":["../../src/utils/webpack-error-utils.ts"],"names":["stageCodeToReadableLabel","develop","transformWebpackError","stage","webpackError","handlers","regex","cb","match","id","context","sourceMessage","packageName","webpackMessage","error","message","shared","filePath","module","resource","location","loc","start","undefined","stageLabel","structured","matched","structureWebpackErrors","Array","isArray","map","e","reportWebpackWarnings","stats","compilation","warnings","forEach","webpackWarning","warning","reporter","warn","toString"],"mappings":"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","sourcesContent":["import reporter from \"gatsby-cli/lib/reporter\"\nimport { Stats } from \"webpack\"\nimport { IMatch } from \"../types\"\n\nconst stageCodeToReadableLabel = {\n  \"build-javascript\": `Generating JavaScript bundles`,\n  \"build-html\": `Generating SSR bundle`,\n  develop: `Generating development JavaScript bundle`,\n} as const\n\ntype Stage = keyof typeof stageCodeToReadableLabel\ntype StageLabel = typeof stageCodeToReadableLabel[Stage]\n\ninterface ITransformedWebpackError {\n  id: string\n  filePath?: string\n  location?: {\n    start: string\n  }\n  context: {\n    stage: Stage\n    stageLabel: StageLabel\n    sourceMessage?: string\n    [key: string]: unknown\n  }\n}\n\nconst transformWebpackError = (\n  stage: keyof typeof stageCodeToReadableLabel,\n  webpackError: any\n): ITransformedWebpackError => {\n  const handlers = [\n    {\n      regex: /Can't resolve '(.*?)' in '(.*?)'/m,\n      cb: (match): IMatch => {\n        return {\n          id: `98124`,\n          context: {\n            sourceMessage: match[0],\n            packageName: match[1],\n          },\n        }\n      },\n    },\n  ]\n\n  const webpackMessage = webpackError?.error?.message || webpackError?.message\n\n  const shared = {\n    filePath: webpackError?.module?.resource,\n    location:\n      webpackError?.module?.resource && webpackError?.error?.loc\n        ? {\n            start: webpackError.error.loc,\n          }\n        : undefined,\n    context: {\n      stage,\n      stageLabel: stageCodeToReadableLabel[stage],\n      sourceMessage: webpackMessage,\n    },\n    // We use original error to display stack trace for the most part.\n    // In case of webpack error stack will include internals of webpack\n    // or one of loaders (for example babel-loader) and doesn't provide\n    // much value to user, so it's purposely omitted.\n\n    // error: webpackError?.error || webpackError,\n  }\n\n  let structured: ITransformedWebpackError | undefined\n\n  for (const { regex, cb } of handlers) {\n    const matched = webpackMessage?.match(regex)\n    if (matched) {\n      const match = cb(matched)\n\n      structured = {\n        id: match.id,\n        ...shared,\n        context: {\n          ...shared.context,\n          packageName: match.context.packageName,\n          sourceMessage: match.context.sourceMessage,\n        },\n      }\n\n      break\n    }\n  }\n\n  // If we haven't found any known error\n  if (!structured) {\n    return {\n      id: `98123`,\n      ...shared,\n    }\n  }\n\n  return structured\n}\n\nexport const structureWebpackErrors = (\n  stage: Stage,\n  webpackError: any\n): ITransformedWebpackError[] | ITransformedWebpackError => {\n  if (Array.isArray(webpackError)) {\n    return webpackError.map(e => transformWebpackError(stage, e))\n  }\n\n  return transformWebpackError(stage, webpackError)\n}\n\nexport const reportWebpackWarnings = (stats: Stats): void => {\n  stats.compilation.warnings.forEach(webpackWarning => {\n    if (webpackWarning.warning) {\n      // grab inner Exception if it exists\n      reporter.warn(webpackWarning.warning.toString())\n    } else {\n      reporter.warn(webpackWarning.message)\n    }\n  })\n}\n"],"file":"webpack-error-utils.js"}