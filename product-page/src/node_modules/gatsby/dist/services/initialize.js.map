{"version":3,"sources":["../../src/services/initialize.ts"],"names":["process","on","reason","reporter","panic","initialize","program","args","parentSpan","setStore","store","directory","browserslist","dispatch","type","payload","activityForJobs","emitter","phantomActivity","start","onEndJob","getState","jobs","active","length","end","activity","activityTimer","configModule","configFilePath","config","id","context","configName","path","__experimentalThemes","warn","themes","useLegacyThemes","rootDir","plugins","polyfill","internalActions","setSiteConfig","flattenedPlugins","pluginsStr","_","uniq","map","p","name","version","telemetry","decorateEvent","span","env","GATSBY_EXPERIMENTAL_PAGE_BUILD_ON_DATA_CHANGES","NODE_ENV","pluginVersions","hashes","Promise","all","resolve","catch","pluginsHash","crypto","createHash","update","JSON","stringify","concat","digest","state","oldPluginsHash","status","PLUGINS_HASH","info","stripIndent","cacheDirectory","fs","remove","emptyDir","e","error","pluginCachesPurged","ensureDir","srcDir","__dirname","siteDir","tryRequire","copy","ensureDirSync","err","hasAPIFile","plugin","skipSSR","undefined","envAPIs","require","join","Array","isArray","isResolved","ssrPlugins","options","pluginOptions","filter","browserPlugins","browserPluginsRequires","relativePluginPath","relative","browserAPIRunner","sSRAPIRunner","readFileSync","ssrPluginsRequires","writeFileSync","extensions","apiResults","traceId","flattenDeep","workerPool","WorkerPool","create"],"mappings":"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","sourcesContent":["import _ from \"lodash\"\nimport { slash } from \"gatsby-core-utils\"\nimport fs from \"fs-extra\"\nimport md5File from \"md5-file/promise\"\nimport crypto from \"crypto\"\nimport del from \"del\"\nimport path from \"path\"\nimport telemetry from \"gatsby-telemetry\"\n\nimport apiRunnerNode from \"../utils/api-runner-node\"\nimport { getBrowsersList } from \"../utils/browserslist\"\nimport { Store, AnyAction } from \"redux\"\nimport { preferDefault } from \"../bootstrap/prefer-default\"\nimport * as WorkerPool from \"../utils/worker/pool\"\nimport JestWorker from \"jest-worker\"\nimport { startPluginRunner } from \"../redux/plugin-runner\"\nimport { loadPlugins } from \"../bootstrap/load-plugins\"\nimport { store, emitter } from \"../redux\"\nimport loadThemes from \"../bootstrap/load-themes\"\nimport reporter from \"gatsby-cli/lib/reporter\"\nimport { getConfigFile } from \"../bootstrap/get-config-file\"\nimport { removeStaleJobs } from \"../bootstrap/remove-stale-jobs\"\nimport { IPluginInfoOptions } from \"../bootstrap/load-plugins/types\"\nimport { internalActions } from \"../redux/actions\"\nimport { IGatsbyState } from \"../redux/types\"\nimport { IBuildContext } from \"./types\"\n\ninterface IPluginResolution {\n  resolve: string\n  options: IPluginInfoOptions\n}\n\n// Show stack trace on unhandled promises.\nprocess.on(`unhandledRejection`, (reason: unknown) => {\n  // https://github.com/DefinitelyTyped/DefinitelyTyped/issues/33636\n  reporter.panic((reason as Error) || `Unhandled rejection`)\n})\n\n// Override console.log to add the source file + line number.\n// Useful for debugging if you lose a console.log somewhere.\n// Otherwise leave commented out.\n// require(`../bootstrap/log-line-function`)\n\nexport async function initialize({\n  program: args,\n  parentSpan,\n}: IBuildContext): Promise<{\n  store: Store<IGatsbyState, AnyAction>\n  workerPool: JestWorker\n}> {\n  if (!args) {\n    reporter.panic(`Missing program args`)\n  }\n\n  /* Time for a little story...\n   * When running `gatsby develop`, the globally installed gatsby-cli starts\n   * and sets up a Redux store (which is where logs are now stored). When gatsby\n   * finds your project's locally installed gatsby-cli package in node_modules,\n   * it switches over. This instance will have a separate redux store. We need to\n   * ensure that the correct store is used which is why we call setStore\n   * (/packages/gatsby-cli/src/reporter/redux/index.js)\n   *\n   * This function\n   * - copies over the logs from the global gatsby-cli to the local one\n   * - sets the store to the local one (so that further actions dispatched by\n   * the global gatsby-cli are handled by the local one)\n   */\n  if (args.setStore) {\n    args.setStore(store)\n  }\n\n  // Start plugin runner which listens to the store\n  // and invokes Gatsby API based on actions.\n  startPluginRunner()\n\n  const directory = slash(args.directory)\n\n  const program = {\n    ...args,\n    browserslist: getBrowsersList(directory),\n    // Fix program directory path for windows env.\n    directory,\n  }\n\n  store.dispatch({\n    type: `SET_PROGRAM`,\n    payload: program,\n  })\n\n  let activityForJobs\n\n  emitter.on(`CREATE_JOB`, () => {\n    if (!activityForJobs) {\n      activityForJobs = reporter.phantomActivity(`Running jobs`)\n      activityForJobs.start()\n    }\n  })\n\n  const onEndJob = (): void => {\n    if (activityForJobs && store.getState().jobs.active.length === 0) {\n      activityForJobs.end()\n      activityForJobs = null\n    }\n  }\n\n  emitter.on(`END_JOB`, onEndJob)\n\n  // Try opening the site's gatsby-config.js file.\n  let activity = reporter.activityTimer(`open and validate gatsby-configs`, {\n    parentSpan,\n  })\n  activity.start()\n  const { configModule, configFilePath } = await getConfigFile(\n    program.directory,\n    `gatsby-config`\n  )\n  let config = preferDefault(configModule)\n\n  // The root config cannot be exported as a function, only theme configs\n  if (typeof config === `function`) {\n    reporter.panic({\n      id: `10126`,\n      context: {\n        configName: `gatsby-config`,\n        path: program.directory,\n      },\n    })\n  }\n\n  // theme gatsby configs can be functions or objects\n  if (config && config.__experimentalThemes) {\n    reporter.warn(\n      `The gatsby-config key \"__experimentalThemes\" has been deprecated. Please use the \"plugins\" key instead.`\n    )\n    const themes = await loadThemes(config, {\n      useLegacyThemes: true,\n      configFilePath,\n      rootDir: program.directory,\n    })\n    config = themes.config\n\n    store.dispatch({\n      type: `SET_RESOLVED_THEMES`,\n      payload: themes.themes,\n    })\n  } else if (config) {\n    const plugins = await loadThemes(config, {\n      useLegacyThemes: false,\n      configFilePath,\n      rootDir: program.directory,\n    })\n    config = plugins.config\n  }\n\n  if (config && config.polyfill) {\n    reporter.warn(\n      `Support for custom Promise polyfills has been removed in Gatsby v2. We only support Babel 7's new automatic polyfilling behavior.`\n    )\n  }\n\n  store.dispatch(internalActions.setSiteConfig(config))\n\n  activity.end()\n\n  // run stale jobs\n  store.dispatch(removeStaleJobs(store.getState()))\n\n  activity = reporter.activityTimer(`load plugins`, {\n    parentSpan,\n  })\n  activity.start()\n  const flattenedPlugins = await loadPlugins(config, program.directory)\n  activity.end()\n\n  // Multiple occurrences of the same name-version-pair can occur,\n  // so we report an array of unique pairs\n  const pluginsStr = _.uniq(flattenedPlugins.map(p => `${p.name}@${p.version}`))\n  telemetry.decorateEvent(`BUILD_END`, {\n    plugins: pluginsStr,\n  })\n\n  telemetry.decorateEvent(`DEVELOP_STOP`, {\n    plugins: pluginsStr,\n  })\n\n  // onPreInit\n  activity = reporter.activityTimer(`onPreInit`, {\n    parentSpan,\n  })\n  activity.start()\n  await apiRunnerNode(`onPreInit`, { parentSpan: activity.span })\n  activity.end()\n\n  // During builds, delete html and css files from the public directory as we don't want\n  // deleted pages and styles from previous builds to stick around.\n  if (\n    !process.env.GATSBY_EXPERIMENTAL_PAGE_BUILD_ON_DATA_CHANGES &&\n    process.env.NODE_ENV === `production`\n  ) {\n    activity = reporter.activityTimer(\n      `delete html and css files from previous builds`,\n      {\n        parentSpan,\n      }\n    )\n    activity.start()\n    await del([\n      `public/**/*.{html,css}`,\n      `!public/page-data/**/*`,\n      `!public/static`,\n      `!public/static/**/*.{html,css}`,\n    ])\n    activity.end()\n  }\n\n  activity = reporter.activityTimer(`initialize cache`, {\n    parentSpan,\n  })\n  activity.start()\n  // Check if any plugins have been updated since our last run. If so\n  // we delete the cache is there's likely been changes\n  // since the previous run.\n  //\n  // We do this by creating a hash of all the version numbers of installed\n  // plugins, the site's package.json, gatsby-config.js, and gatsby-node.js.\n  // The last, gatsby-node.js, is important as many gatsby sites put important\n  // logic in there e.g. generating slugs for custom pages.\n  const pluginVersions = flattenedPlugins.map(p => p.version)\n  const hashes = await Promise.all([\n    !!process.env.GATSBY_EXPERIMENTAL_PAGE_BUILD_ON_DATA_CHANGES,\n    md5File(`package.json`),\n    Promise.resolve(\n      md5File(`${program.directory}/gatsby-config.js`).catch(() => {})\n    ), // ignore as this file isn't required),\n    Promise.resolve(\n      md5File(`${program.directory}/gatsby-node.js`).catch(() => {})\n    ), // ignore as this file isn't required),\n  ])\n  const pluginsHash = crypto\n    .createHash(`md5`)\n    .update(JSON.stringify(pluginVersions.concat(hashes)))\n    .digest(`hex`)\n  const state = store.getState()\n  const oldPluginsHash = state && state.status ? state.status.PLUGINS_HASH : ``\n\n  // Check if anything has changed. If it has, delete the site's .cache\n  // directory and tell reducers to empty themselves.\n  //\n  // Also if the hash isn't there, then delete things just in case something\n  // is weird.\n  if (oldPluginsHash && pluginsHash !== oldPluginsHash) {\n    reporter.info(reporter.stripIndent`\n      One or more of your plugins have changed since the last time you ran Gatsby. As\n      a precaution, we're deleting your site's cache to ensure there's no stale data.\n    `)\n  }\n  const cacheDirectory = `${program.directory}/.cache`\n  if (!oldPluginsHash || pluginsHash !== oldPluginsHash) {\n    try {\n      // Attempt to empty dir if remove fails,\n      // like when directory is mount point\n      await fs.remove(cacheDirectory).catch(() => fs.emptyDir(cacheDirectory))\n    } catch (e) {\n      reporter.error(`Failed to remove .cache files.`, e)\n    }\n    // Tell reducers to delete their data (the store will already have\n    // been loaded from the file system cache).\n    store.dispatch({\n      type: `DELETE_CACHE`,\n    })\n\n    // in future this should show which plugin's caches are purged\n    // possibly should also have which plugins had caches\n    telemetry.decorateEvent(`BUILD_END`, {\n      pluginCachesPurged: [`*`],\n    })\n    telemetry.decorateEvent(`DEVELOP_STOP`, {\n      pluginCachesPurged: [`*`],\n    })\n  }\n\n  // Update the store with the new plugins hash.\n  store.dispatch({\n    type: `UPDATE_PLUGINS_HASH`,\n    payload: pluginsHash,\n  })\n\n  // Now that we know the .cache directory is safe, initialize the cache\n  // directory.\n  await fs.ensureDir(cacheDirectory)\n\n  // Ensure the public/static directory\n  await fs.ensureDir(`${program.directory}/public/static`)\n\n  activity.end()\n\n  activity = reporter.activityTimer(`copy gatsby files`, {\n    parentSpan,\n  })\n  activity.start()\n  const srcDir = `${__dirname}/../../cache-dir`\n  const siteDir = cacheDirectory\n  const tryRequire = `${__dirname}/../utils/test-require-error.js`\n  try {\n    await fs.copy(srcDir, siteDir)\n    await fs.copy(tryRequire, `${siteDir}/test-require-error.js`)\n    await fs.ensureDirSync(`${cacheDirectory}/json`)\n\n    // Ensure .cache/fragments exists and is empty. We want fragments to be\n    // added on every run in response to data as fragments can only be added if\n    // the data used to create the schema they're dependent on is available.\n    await fs.emptyDir(`${cacheDirectory}/fragments`)\n  } catch (err) {\n    reporter.panic(`Unable to copy site files to .cache`, err)\n  }\n\n  // Find plugins which implement gatsby-browser and gatsby-ssr and write\n  // out api-runners for them.\n  const hasAPIFile = (env, plugin): string | undefined => {\n    // The plugin loader has disabled SSR APIs for this plugin. Usually due to\n    // multiple implementations of an API that can only be implemented once\n    if (env === `ssr` && plugin.skipSSR === true) return undefined\n\n    const envAPIs = plugin[`${env}APIs`]\n\n    // Always include gatsby-browser.js files if they exist as they're\n    // a handy place to include global styles and other global imports.\n    try {\n      if (env === `browser`) {\n        return slash(\n          require.resolve(path.join(plugin.resolve, `gatsby-${env}`))\n        )\n      }\n    } catch (e) {\n      // ignore\n    }\n\n    if (envAPIs && Array.isArray(envAPIs) && envAPIs.length > 0) {\n      return slash(path.join(plugin.resolve, `gatsby-${env}`))\n    }\n    return undefined\n  }\n\n  const isResolved = (plugin): plugin is IPluginResolution => !!plugin.resolve\n\n  const ssrPlugins: IPluginResolution[] = flattenedPlugins\n    .map(plugin => {\n      return {\n        resolve: hasAPIFile(`ssr`, plugin),\n        options: plugin.pluginOptions,\n      }\n    })\n    .filter(isResolved)\n\n  const browserPlugins: IPluginResolution[] = flattenedPlugins\n    .map(plugin => {\n      return {\n        resolve: hasAPIFile(`browser`, plugin),\n        options: plugin.pluginOptions,\n      }\n    })\n    .filter(isResolved)\n\n  const browserPluginsRequires = browserPlugins\n    .map(plugin => {\n      // we need a relative import path to keep contenthash the same if directory changes\n      const relativePluginPath = path.relative(siteDir, plugin.resolve)\n      return `{\n      plugin: require('${slash(relativePluginPath)}'),\n      options: ${JSON.stringify(plugin.options)},\n    }`\n    })\n    .join(`,`)\n\n  const browserAPIRunner = `module.exports = [${browserPluginsRequires}]\\n`\n\n  let sSRAPIRunner = ``\n\n  try {\n    sSRAPIRunner = fs.readFileSync(`${siteDir}/api-runner-ssr.js`, `utf-8`)\n  } catch (err) {\n    reporter.panic(`Failed to read ${siteDir}/api-runner-ssr.js`, err)\n  }\n\n  const ssrPluginsRequires = ssrPlugins\n    .map(\n      plugin =>\n        `{\n      plugin: require('${plugin.resolve}'),\n      options: ${JSON.stringify(plugin.options)},\n    }`\n    )\n    .join(`,`)\n  sSRAPIRunner = `var plugins = [${ssrPluginsRequires}]\\n${sSRAPIRunner}`\n\n  fs.writeFileSync(\n    `${siteDir}/api-runner-browser-plugins.js`,\n    browserAPIRunner,\n    `utf-8`\n  )\n  fs.writeFileSync(`${siteDir}/api-runner-ssr.js`, sSRAPIRunner, `utf-8`)\n\n  activity.end()\n  /**\n   * Start the main bootstrap processes.\n   */\n\n  // onPreBootstrap\n  activity = reporter.activityTimer(`onPreBootstrap`, {\n    parentSpan,\n  })\n  activity.start()\n  await apiRunnerNode(`onPreBootstrap`, {\n    parentSpan: activity.span,\n  })\n  activity.end()\n\n  // Collect resolvable extensions and attach to program.\n  const extensions = [`.mjs`, `.js`, `.jsx`, `.wasm`, `.json`]\n  // Change to this being an action and plugins implement `onPreBootstrap`\n  // for adding extensions.\n  const apiResults = await apiRunnerNode(`resolvableExtensions`, {\n    traceId: `initial-resolvableExtensions`,\n    parentSpan,\n  })\n\n  store.dispatch({\n    type: `SET_PROGRAM_EXTENSIONS`,\n    payload: _.flattenDeep([extensions, apiResults]),\n  })\n\n  const workerPool = WorkerPool.create()\n\n  return {\n    store,\n    workerPool,\n  }\n}\n"],"file":"initialize.js"}