{"version":3,"sources":["../../src/query/graphql-span-tracer.ts"],"names":["GraphQLSpanTracer","constructor","name","activityArgs","parentActivity","report","phantomActivity","activities","Map","getParentActivity","start","end","forEach","activity","createResolverActivity","path","prev","key","parentSpan","getActivity","span","tags","field","join","setActivity","gqlPath","length","get","set"],"mappings":";;;;;;;AAEA;;AAKA;;AAEA;;;;AAIe,MAAMA,iBAAN,CAAsD;AAInEC,EAAAA,WAAW,CAACC,IAAD,EAAeC,YAAf,EAA4C;AACrD,SAAKC,cAAL,GAAsBC,kBAAOC,eAAP,CACpBJ,IADoB,EAEpBC,YAFoB,CAAtB;AAIA,SAAKI,UAAL,GAAkB,IAAIC,GAAJ,EAAlB;AACD;;AAEDC,EAAAA,iBAAiB,GAAqB;AACpC,WAAO,KAAKL,cAAZ;AACD;;AAEDM,EAAAA,KAAK,GAAS;AACZ,SAAKN,cAAL,CAAoBM,KAApB;AACD;;AAEDC,EAAAA,GAAG,GAAS;AACV,SAAKJ,UAAL,CAAgBK,OAAhB,CAAwBC,QAAQ,IAAI;AAClCA,MAAAA,QAAQ,CAACF,GAAT;AACD,KAFD;AAGA,SAAKP,cAAL,CAAoBO,GAApB;AACD;;AAEDG,EAAAA,sBAAsB,CAACC,IAAD,EAAab,IAAb,EAA6C;AACjE,QAAIc,IAAsB,GAAGD,IAAI,CAACC,IAAlC;;AACA,WAAO,iBAAOA,IAAP,0CAAO,MAAMC,GAAb,MAAsB,QAA7B,EAAsC;AAAA;;AACpCD,MAAAA,IAAI,GAAGA,IAAI,CAACA,IAAZ;AACD;;AACD,UAAME,UAAU,GAAG,KAAKC,WAAL,CAAiBH,IAAjB,EAAuBI,IAA1C;;AACA,UAAMP,QAAQ,GAAGR,kBAAOC,eAAP,CAAwB,kBAAxB,EAA2C;AAC1DY,MAAAA,UAD0D;AAE1DG,MAAAA,IAAI,EAAE;AACJC,QAAAA,KAAK,EAAEpB,IADH;AAEJa,QAAAA,IAAI,EAAE,wBAAYA,IAAZ,EAAkBQ,IAAlB,CAAwB,GAAxB;AAFF;AAFoD,KAA3C,CAAjB;;AAOA,SAAKC,WAAL,CAAiBT,IAAjB,EAAuBF,QAAvB;AACA,WAAOA,QAAP;AACD;;AAEDM,EAAAA,WAAW,CAACM,OAAD,EAA8C;AACvD,UAAMV,IAAI,GAAG,wBAAYU,OAAZ,CAAb;AACA,QAAIZ,QAAJ;;AACA,QAAIE,IAAI,CAACW,MAAL,GAAc,CAAlB,EAAqB;AACnBb,MAAAA,QAAQ,GAAG,KAAKN,UAAL,CAAgBoB,GAAhB,CAAoBZ,IAAI,CAACQ,IAAL,CAAW,GAAX,CAApB,CAAX;;AACA,UAAIV,QAAJ,EAAc;AACZ,eAAOA,QAAP;AACD;AACF;;AAED,WAAO,KAAKT,cAAZ;AACD;;AAEDoB,EAAAA,WAAW,CAACC,OAAD,EAAgBZ,QAAhB,EAAkD;AAC3D,UAAME,IAAI,GAAG,wBAAYU,OAAZ,CAAb;AACA,SAAKlB,UAAL,CAAgBqB,GAAhB,CAAoBb,IAAI,CAACQ,IAAL,CAAW,GAAX,CAApB,EAAoCV,QAApC;AACD;;AA5DkE","sourcesContent":["import { Path } from \"graphql/jsutils/Path\"\n\nimport report from \"gatsby-cli/lib/reporter\"\nimport { IActivityArgs } from \"gatsby-cli/src/reporter/reporter\"\nimport { IPhantomReporter } from \"gatsby-cli/src/reporter/reporter-phantom\"\n\nimport { IGraphQLSpanTracer } from \"../schema/type-definitions\"\nimport { pathToArray } from \"./utils\"\n\n/**\n * Tracks and knows how to get a parent span for a particular\n *  point in query resolver for a particular query and path\n */\nexport default class GraphQLSpanTracer implements IGraphQLSpanTracer {\n  parentActivity: IPhantomReporter\n  activities: Map<string, IPhantomReporter>\n\n  constructor(name: string, activityArgs: IActivityArgs) {\n    this.parentActivity = report.phantomActivity(\n      name,\n      activityArgs\n    ) as IPhantomReporter\n    this.activities = new Map()\n  }\n\n  getParentActivity(): IPhantomReporter {\n    return this.parentActivity\n  }\n\n  start(): void {\n    this.parentActivity.start()\n  }\n\n  end(): void {\n    this.activities.forEach(activity => {\n      activity.end()\n    })\n    this.parentActivity.end()\n  }\n\n  createResolverActivity(path: Path, name: string): IPhantomReporter {\n    let prev: Path | undefined = path.prev\n    while (typeof prev?.key === `number`) {\n      prev = prev.prev\n    }\n    const parentSpan = this.getActivity(prev).span\n    const activity = report.phantomActivity(`GraphQL Resolver`, {\n      parentSpan,\n      tags: {\n        field: name,\n        path: pathToArray(path).join(`.`),\n      },\n    })\n    this.setActivity(path, activity)\n    return activity\n  }\n\n  getActivity(gqlPath: Path | undefined): IPhantomReporter {\n    const path = pathToArray(gqlPath)\n    let activity\n    if (path.length > 0) {\n      activity = this.activities.get(path.join(`.`))\n      if (activity) {\n        return activity\n      }\n    }\n\n    return this.parentActivity\n  }\n\n  setActivity(gqlPath: Path, activity: IPhantomReporter): void {\n    const path = pathToArray(gqlPath)\n    this.activities.set(path.join(`.`), activity)\n  }\n}\n"],"file":"graphql-span-tracer.js"}